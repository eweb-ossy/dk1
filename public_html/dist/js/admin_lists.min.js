!function(){function l(e,t){if((t=(t=(t=(t=(t=(t=t.replace(/YYYY/g,e.getFullYear())).replace(/MM/g,("0"+(e.getMonth()+1)).slice(-2))).replace(/DD/g,("0"+e.getDate()).slice(-2))).replace(/hh/g,("0"+e.getHours()).slice(-2))).replace(/mm/g,("0"+e.getMinutes()).slice(-2))).replace(/ss/g,("0"+e.getSeconds()).slice(-2))).match(/S/g))for(var r=("00"+e.getMilliseconds()).slice(-3),a=t.match(/S/g).length,n=0;n<a;n++)t=t.replace(/S/,r.substring(n,n+1));return t}var r,u,a,n,d,m,c,h,f,b,i,o,s={},g={},_="none";Cookies.get("toListsuserID")?(i=Cookies.get("toListsuserID"),o=new Date(Cookies.get("toListsMonth"))):window.location.href="/";const p={getTableColumns:function(){return $.ajax({url:"../../data/columns/lists",dataType:"json",type:"POST"})},getUserData:function(){return $.ajax({url:"../../data/admin_lists/user_data",dataType:"json",type:"POST",data:{user_id:i,year:l(new Date(o),"YYYY"),month:l(new Date(o),"MM")}})},save_data:function(){return $.ajax({type:"POST",dataType:"json",url:"../../data/admin_list_day/save",data:{today:g.date,user_id:i,in_time:$("#picker_in_time").val(),out_time:$("#picker_out_time").val(),rest:$("#rest_range").val(),memo:$("#memo").val(),area_id:$('select[name="place"] option:selected').attr("data-area-id"),shift_in_time:$("#picker_shift_in_time").val(),shift_out_time:$("#picker_shift_out_time").val(),shift_rest:$("#shift_rest_range").val(),shift_status:_,shift_hour:b}})},downloadData:function(e){var e="../../data/admin_download/"+e,t=document.createElement("form"),e=(t.setAttribute("action",e),t.setAttribute("method","post"),t.style.display="none",document.body.appendChild(t),document.createElement("input")),e=(e.setAttribute("type","hidden"),e.setAttribute("name","column"),e.setAttribute("value",JSON.stringify(a)),t.appendChild(e),document.createElement("input")),e=(e.setAttribute("type","hidden"),e.setAttribute("name","dl_data"),e.setAttribute("value",JSON.stringify(n)),t.appendChild(e),document.createElement("input")),e=(e.setAttribute("type","hidden"),e.setAttribute("name","type"),e.setAttribute("value","user_detail"),t.appendChild(e),document.createElement("input")),e=(e.setAttribute("type","hidden"),e.setAttribute("name","data_date"),e.setAttribute("value",l(new Date(o),"YYYY年MM月")+" "+$("#user_name").text()+" "+$("#user_id").text()),t.appendChild(e),document.createElement("input"));e.setAttribute("type","hidden"),e.setAttribute("name","all_data"),e.setAttribute("value",JSON.stringify(s)),t.appendChild(e),t.submit()},listData:function(e){var t=e.filter(function(e){return 0<e.work_hour2}),t=(s.work_minute=t.reduce(function(e,t){return e+Number(t.work_hour2)},0),0<s.work_minute?s.work_hour=Math.floor(s.work_minute/60)+":"+("0"+s.work_minute%60).slice(-2):s.work_hour="",e.filter(function(e){return 0<e.normal_hour2})),t=(s.normal_minute=t.reduce(function(e,t){return e+Number(t.normal_hour2)},0),0<s.normal_minute?s.normal_hour=Math.floor(s.normal_minute/60)+":"+("0"+s.normal_minute%60).slice(-2):s.normal_hour="",e.filter(function(e){return 0<e.shift_hour2})),t=(s.shift_hour2=t.reduce(function(e,t){return e+Number(t.shift_hour2)},0),0<s.shift_hour2?s.shift_hour=Math.floor(s.shift_hour2/60)+":"+("0"+s.shift_hour2%60).slice(-2):s.shift_hour="",e.filter(function(e){return 0<e.rest_hour2})),t=(s.rest_minute=t.reduce(function(e,t){return e+Number(t.rest_hour2)},0),0<s.rest_minute?s.rest_hour=Math.floor(s.rest_minute/60)+":"+("0"+s.rest_minute%60).slice(-2):s.rest_hour="",e.filter(function(e){return 0<e.over_hour2})),t=(s.over_minute=t.reduce(function(e,t){return e+Number(t.over_hour2)},0),0<s.over_minute?s.over_hour=Math.floor(s.over_minute/60)+":"+("0"+s.over_minute%60).slice(-2):s.over_hour="",e.filter(function(e){return 0<e.night_hour2})),t=(s.night_minute=t.reduce(function(e,t){return e+Number(t.night_hour2)},0),0<s.night_minute?s.night_hour=Math.floor(s.night_minute/60)+":"+("0"+s.night_minute%60).slice(-2):s.night_hour="",e.filter(function(e){return 0<e.late_hour2})),t=(s.late_minute=t.reduce(function(e,t){return e+Number(t.late_hour2)},0),0<s.late_minute?s.late_hour=Math.floor(s.late_minute/60)+":"+("0"+s.late_minute%60).slice(-2):s.late_hour="",e.filter(function(e){return 0<e.left_hour2})),t=(s.left_minute=t.reduce(function(e,t){return e+Number(t.left_hour2)},0),0<s.left_minute?s.left_hour=Math.floor(s.left_minute/60)+":"+("0"+s.left_minute%60).slice(-2):s.left_hour="",e.filter(function(e){return e.in_work_time})),t=(s.in_work_time=t.length,e.filter(function(e){return e.out_work_time}));s.out_work_time=t.length},getSelectUsers:function(){var e=l(new Date(o.getFullYear(),o.getMonth()+1,0),"YYYY-MM-DD");return $.ajax({type:"POST",dataType:"json",url:"../../data/admin_lists/select_users",data:{now_date:e}})}};function v(e){var t=[];if(0<e.length){for(var r=0;r<e.length;r++)t.push(e[r]._row.data);p.listData(t),n=t}}const k={renderDate:new Promise(function(e,t){u=flatpickr("#month",{plugins:[new monthSelectPlugin({dateFormat:"Y年m月",theme:"light"})],onChange:function(){o=u.selectedDates[0],k.renderTableData(),k.renderDateText(o)}}),e()}),renderDateText:function(t){u.setDate(t);let r,a,n;if(0<end_day){var i=new Date(t),o=(i.setMonth(i.getMonth()-1),end_day+1);r=l(i,"YYYY年MM月")+o+"日",a=l(t,"YYYY年MM月")+end_day+"日";let e=new Date(i.getFullYear(),i.getMonth()+1,0);e=e.getDate(),n=e-end_day+end_day}else{r=l(new Date(t),"YYYY年MM月")+"01日",a=l(new Date(t.getFullYear(),t.getMonth()+1,0),"YYYY年MM月DD日");o=new Date(t.getFullYear(),t.getMonth()+1,0);n=o.getDate()}$("#to_from_date").text(r+"から"+a+"までの"+n+"日間");var i=new Intl.DateTimeFormat("ja-JP-u-ca-japanese",{era:"long",year:"numeric"}).format(new Date(t)),o=($("#date-area-wareki").text(i),new Date),i=o.getFullYear(),o=o.getMonth(),t=new Date(t),e=t.getFullYear(),t=t.getMonth(),i=new Date(i,o),o=new Date(e,t),e=i.getMonth()-o.getMonth()+12*(i.getFullYear()-o.getFullYear());0==e?($("#this_month").addClass("disable"),$("#this_month_mark").addClass("this-month"),$("#this_month_mark").text("今月")):($("#this_month").removeClass("disable"),$("#this_month_mark").removeClass("this-month"),0<e?$("#this_month_mark").text(e+"ヶ月前"):$("#this_month_mark").text(Math.abs(e)+"ヶ月後"))},renderTableColumns:new Promise(function(t,e){p.getTableColumns().done(function(e){(a=e.filter(e=>e.output)).forEach((e,t)=>{let r=0===t?"合計":"";e.field?s[e.field]=r:e.columns.forEach(e=>{s[e.field]=r})}),r=new Tabulator("#data_table",{layout:"fitColumns",height:"calc(100vh - 270px)",columnMinWidth:20,columns:e,tooltips:function(e){var t=e.getColumn(),t=("in_work_time"!=t._column.field&&"out_work_time"!=t._column.field&&"work_hour"!=t._column.field&&"work_minute"!=t._column.field&&"rest_hour"!=t._column.field&&"rest_minute"!=t._column.field&&"status"!=t._column.field||(e.getElement().style.color="#1591a2"),"over_hour"!=t._column.field&&"over_minute"!=t._column.field&&"night_hour"!=t._column.field&&"night_minute"!=t._column.field&&"late_hour"!=t._column.field&&"late_minute"!=t._column.field&&"left_hour"!=t._column.field&&"left_minute"!=t._column.field||(e.getElement().style.color="#ff4560"),"normal_hour"!=t._column.field&&"normal_minute"!=t._column.field||(e.getElement().style.color="#673AB7"),"shift_in_time"!=t._column.field&&"shift_out_time"!=t._column.field&&"shift_hour"!=t._column.field||(e.getElement().style.color="#9abcea"),e.getValue());"日"!=t&&"祝"!=t||(e.getElement().style.color="#F44336"),"土"==t&&(e.getElement().style.color="#0D47A1"),"片打刻"==t&&(e.getElement().style.color="#ff4560"),"未出勤"==t&&(e.getElement().style.color="#673ab7"),"出勤"==t&&(e.getElement().style.color="#9abcea"),"公休"==t&&(e.getElement().style.color="#F44336"),"有給"!=t&&"有給取得"!=t||(e.getElement().style.color="#fff",e.getElement().style.background="#40a598"),"欠勤"==t&&(e.getElement().style.color="#fff",e.getElement().style.background="#fd6b80")},dataFiltered:function(e,t){v(t)},dataSorted:function(e,t){v(t)},rowClick:function(e,t){2!==authority&&5!==authority&&(g=t.getData()).day&&k.render_modal(g)},invalidOptionWarnings:!1}),t(),r.hideColumn("work_hour2"),r.hideColumn("rest_hour2"),r.hideColumn("over_hour2"),r.hideColumn("night_hour2"),r.hideColumn("late_hour2"),r.hideColumn("left_hour2"),r.hideColumn("today_flag"),r.hideColumn("in_latitude"),r.hideColumn("in_longitude"),r.hideColumn("out_latitude"),r.hideColumn("out_longitude"),r.hideColumn("normal_hour2"),r.hideColumn("shift_hour2"),r.hideColumn("shift_rest"),r.hideColumn("area_id"),r.hideColumn("date")})}),renderTableData:function(){r.clearData(),r.replaceData("../../data/admin_lists/table_data",{year:l(new Date(o),"YYYY"),month:l(new Date(o),"MM"),user_id:i,end_day:end_day},"POST").then(function(){k.renderListData()})},renderUserData:function(){p.getUserData().done(function(e){$("#user_kana").text(e.user_kana),$("#user_name").text(e.user_name),$("#user_id").text(i),$("#group1_name").text(e.group1_name),$("#group2_name").text(e.group2_name),$("#group3_name").text(e.group3_name)})},render_modal:function(e){$("#modal_date").text(e.date.substr(0,4)+"年"+e.date.substr(5,2)+"月"+e.day+"日("+e.week+")");var t=e.in_work_time||"",t=(d=flatpickr("#picker_in_time",{enableTime:!0,noCalendar:!0,dateFormat:"H:i",time_24hr:!0,defaultHour:defaultInHour,defaultMinute:defaultInMinute,minuteIncrement:defaultMinuteIncrement,defaultDate:t,onChange:function(){k.render_modal_check()},onClose:function(){k.render_modal_check()}}),m=flatpickr("#picker_out_time",{enableTime:!0,noCalendar:!0,dateFormat:"H:i",time_24hr:!0,defaultHour:defaultOutHour,defaultMinute:defaultOutMinute,minuteIncrement:defaultMinuteIncrement,defaultDate:e.out_work_time,onChange:function(){k.render_modal_check()},onClose:function(){k.render_modal_check()}}),e.shift_in_time||""),t=(c=flatpickr("#picker_shift_in_time",{enableTime:!0,noCalendar:!0,dateFormat:"H:i",time_24hr:!0,defaultHour:defaultInHour,defaultMinute:defaultInMinute,minuteIncrement:defaultMinuteIncrement,defaultDate:t,onChange:function(){k.render_modal_check()},onClose:function(){k.render_modal_check()}}),h=flatpickr("#picker_shift_out_time",{enableTime:!0,noCalendar:!0,dateFormat:"H:i",time_24hr:!0,defaultHour:defaultOutHour,defaultMinute:defaultOutMinute,minuteIncrement:defaultMinuteIncrement,defaultDate:e.shift_out_time,onChange:function(){k.render_modal_check()},onClose:function(){k.render_modal_check()}}),e.in_work_time||"--"),t=($("#in_time").text(t),e.out_work_time||"--"),t=($("#out_time").text(t),e.work_hour2?e.work_hour2+"分":"--"),t=($("#work_value").text(t),e.work_hour||""),t=($("#work_value2").text(t),$("#rest_range").prop("disabled",!1).val(Number(e.rest_hour2)),e.rest_hour2||0),t=(k.render_rest_btn(t),e.rest_hour||"0:00"),r=($("#rest_value2").text(t),(e.area?$('[name="place"] > option[value="'+e.area+'"]'):$('[name="place"] > option[value=""]')).prop("selected",!0),$("#memo").val(e.memo),$(".iziModal-header-title").text($("#user_name").text()),$("#group1_name").text()),a=$("#group2_name").text(),n=$("#group3_name").text(),r=($(".iziModal-header-subtitle").text("ID："+i+"　"+r+"　"+a+"　"+n),e.in_latitude&&e.in_longitude?$("#map_in").html('<iframe src="https://maps.google.co.jp/maps?output=embed&t=m&hl=ja&z=15&ll='+e.in_latitude+","+e.in_longitude+"&q="+e.in_latitude+","+e.in_longitude+'" frameborder="0" scrolling="no" width="323px" height="78px"></iframe>'):$("#map_in").html(""),e.out_latitude&&e.out_longitude?$("#map_out").html('<iframe src="https://maps.google.co.jp/maps?output=embed&t=m&hl=ja&z=15&ll='+e.out_latitude+","+e.out_longitude+"&q="+e.out_latitude+","+e.out_longitude+'" frameborder="0" scrolling="no" width="323px" height="78px"></iframe>'):$("#map_out").html(""),e.shift_in_time||"--"),a=($("#shift_in_time").text(r),e.shift_out_time||"--"),n=($("#shift_out_time").text(a),e.shift_hour2?e.shift_hour2+"分":"--"),r=($("#shift_value").text(n),e.shift_hour||""),a=($("#shift_value2").text(r),f=e.shift_status,k.render_shift_btn(f),$("#shift_rest_range").prop("disabled",!1).val(Number(e.shift_rest)),e.shift_rest||0),t=(k.render_shift_rest_btn(a),e.rest_hour||"0:00");$("#rest_value2").text(t),$("#time_edit_submit").attr("data-user-id",e.user_id),$("#time_edit_submit").addClass("disable"),$("#modal2").iziModal("open")},render_rest_btn:function(e){$(".r_btn").removeClass("active"),$("#rest_"+e).addClass("active"),$("#memori_"+e).addClass("active"),$("#rest_value").text(e+"分");var t=e/60,r=Math.floor(t),t=Math.round(60*(t-r));$("#rest_value2").text(r+":"+("0"+t).slice(-2)),$("#rest_range").val(e),k.render_modal_check()},render_shift_rest_btn:function(e){$(".rs_btn").removeClass("active-s"),$("#shift_rest_"+e).addClass("active-s"),$("#shift_memori_"+e).addClass("active-s"),$("#shift_rest_value").text(e+"分");var t=e/60,r=Math.floor(t),t=Math.round(60*(t-r));$("#shift_rest_value2").text(r+":"+("0"+t).slice(-2)),$("#shift_rest_range").val(e),k.render_modal_check()},render_shift_btn:function(e){var t;$(".shift-btn").removeClass("disabled"),$("#shift_time_edit_area").hide(),_="none","未登録"!==e&&""!==e||($("#state_none").addClass("disabled"),f="",t="#ccc",_="del"),"出勤"===e&&($("#state_work").addClass("disabled"),f="出勤",t="#3788d8",_=0,$("#shift_time_edit_area").show()),"公休"===e&&($("#state_rest").addClass("disabled"),f="公休",_=1,t="#ff7d73"),"有給"===e&&($("#state_raid").addClass("disabled"),f="有給",_=2,t="#40a598"),$("#status_name").text("シフト "+f).css("color",t)},render_modal_check:function(){$("#time_edit_submit").addClass("disable"),$(".time-input, .rest-value, .shift-rest-value").removeClass("error"),$("#work_value, #shift_value").text("--"),$("#work_value2, #shift_value2").text("");var e=d.selectedDates,i=m.selectedDates,o=new Date(e).getHours();let t=60*o+new Date(e).getMinutes();e=new Date(i).getHours();let l=60*e+new Date(i).getMinutes(),u=$("#picker_in_time").val(),s=$("#picker_out_time").val();0<over_day&&(o<=over_day&&(t+=1440,i=u.substr(0,2),o=u.substr(-2),i=Number(i)+24,u=i+":"+o),e<=over_day&&(l+=1440,i=s.substr(0,2),o=s.substr(-2),i=Number(i)+24,s=i+":"+o));e=$("#rest_range").val();if(!t&&!l&&0<e)$(".rest-value").addClass("error");else if(t&&!l&&0<e)$(".rest-value").addClass("error");else if(!t&&l)$("#picker_in_time").addClass("error"),0<e&&$(".rest-value").addClass("error");else{if(t&&l){i=l-t;if(i-e<=0)return void $("#picker_out_time").addClass("error");if(i<=e)return void $(".rest-value").addClass("error");i-=e,$("#work_value").text(i+"分");o=i/60,i=Math.floor(o),o=Math.round(60*(o-i));$("#work_value2").text(i+":"+("0"+o).slice(-2))}let r,a,n;if("出勤"===f){i=new Date(c.selectedDates).getHours();let e=60*i+new Date(c.selectedDates).getMinutes();o=new Date(h.selectedDates).getHours();let t=60*o+new Date(h.selectedDates).getMinutes();if(r=$("#picker_shift_in_time").val(),a=$("#picker_shift_out_time").val(),0<over_day&&(i<=over_day&&(e+=1440,i=r.substr(0,2),_=r.substr(-2),i=Number(i)+24,r=i+":"+_),o<=over_day&&(t+=1440,i=a.substr(0,2),_=a.substr(-2),i=Number(i)+24,a=i+":"+_)),!e)return void $("#picker_shift_in_time").addClass("error");if(!t)return void $("#picker_shift_out_time").addClass("error");if(e&&t){if(n=$("#shift_rest_range").val(),(b=t-e)-n<=0)return void $("#picker_shift_out_time").addClass("error");if(b<=n)return void $(".shift-rest-value").addClass("error");b-=n,$("#shift_value").text(b+"分");var o=b/60,i=Math.floor(o),_=Math.round(60*(o-i));$("#shift_value2").text(i+":"+("0"+_).slice(-2))}}g.in_work_time!=u&&$("#time_edit_submit").removeClass("disable"),g.out_work_time!=s&&$("#time_edit_submit").removeClass("disable");(g.rest_hour2||0)!=e&&$("#time_edit_submit").removeClass("disable");o=$('select[name="place"] option:selected').attr("data-area-id"),i=(g.area_id!=o&&$("#time_edit_submit").removeClass("disable"),$("#memo").val());g.memo!=i&&$("#time_edit_submit").removeClass("disable"),g.shift_status!=f&&$("#time_edit_submit").removeClass("disable"),"出勤"===f&&(g.shift_in_time!=r&&$("#time_edit_submit").removeClass("disable"),g.shift_out_time!=a&&$("#time_edit_submit").removeClass("disable"),(g.shift_rest||0)!=n&&$("#time_edit_submit").removeClass("disable"))}},renderListData:function(){$('.tabulator-calcs-top > [tabulator-field="shift_hour"]').text(s.shift_hour),$('.tabulator-calcs-top > [tabulator-field="work_hour"]').text(s.work_hour),$('.tabulator-calcs-top > [tabulator-field="work_minute"]').text(s.work_minute),$('.tabulator-calcs-top > [tabulator-field="rest_hour"]').text(s.rest_hour),$('.tabulator-calcs-top > [tabulator-field="rest_minute"]').text(s.rest_minute),$('.tabulator-calcs-top > [tabulator-field="over_hour"]').text(s.over_hour),$('.tabulator-calcs-top > [tabulator-field="over_minute"]').text(s.over_minute),$('.tabulator-calcs-top > [tabulator-field="night_hour"]').text(s.night_hour),$('.tabulator-calcs-top > [tabulator-field="night_minute"]').text(s.night_minute),$('.tabulator-calcs-top > [tabulator-field="late_hour"]').text(s.late_hour),$('.tabulator-calcs-top > [tabulator-field="late_minute"]').text(s.late_minute),$('.tabulator-calcs-top > [tabulator-field="left_hour"]').text(s.left_hour),$('.tabulator-calcs-top > [tabulator-field="left_minute"]').text(s.left_minute),$('.tabulator-calcs-top > [tabulator-field="normal_hour"]').text(s.normal_hour),$('.tabulator-calcs-top > [tabulator-field="normal_minute"]').text(s.normal_minute)},renderUserSelect:function(){p.getSelectUsers().done(function(e){$("#user_select").html(""),$.each(e,function(e,t){var r=i==t.user_id?" selected":"";$("#user_select").append('<option value="'+t.user_id+'"'+r+">"+t.user_name+"&nbsp;("+t.user_id+")</option>")})})},renderWeekSelect:function(e){"none"===e?r.clearFilter():("土日祝"===e&&"平日"===e||r.setFilter("week","=",e),"土日祝"===e&&r.setFilter("week","in",["土","日","祝"]),"平日"===e&&r.setFilter("week","in",["月","火","水","木","金"]))},show_toast:function(e){siiimpleToast.message(e,{position:"top|right"})},show_err_toast:function(e){siiimpleToast.alert(e,{position:"top|right"})}};$(function(){function e(e){o=e?new Date(o.setMonth(o.getMonth()+e)):new Date,k.renderDateText(o),k.renderTableData()}Promise.all([k.renderTableColumns,k.renderDate]).then(function(){k.renderDateText(o),k.renderUserData(),k.renderUserSelect(),k.renderTableData()}),$("#modal2").iziModal({headerColor:"#1591a2",focusInput:!1,width:700}),$("#less_month").on("click",function(){e(-1)}),$("#add_month").on("click",function(){e(1)}),$("#this_month_mark, #this_month").on("click",function(){e()}),$("#user_select").on("change",function(){i=$('select[name="user_select"] option:selected').val(),k.renderTableData(),k.renderUserData()}),$("#week_select").on("change",function(){week_filter=$('select[name="week_select"] option:selected').val(),k.renderWeekSelect(week_filter)}),$(document).on("input","#rest_range",function(){var e=$(this).val();k.render_rest_btn(e)}),$(document).on("click",".r_btn",function(){var e=$(this).attr("data-time");k.render_rest_btn(e)}),$(document).on("input change",".time-val",function(){k.render_modal_check()}),$(document).on("click","#picker_del_in_time",function(){d.clear(),k.render_modal_check()}),$(document).on("click","#picker_del_out_time",function(){m.clear(),k.render_modal_check()}),$(document).on("click","#shift_view_btn",function(){$(this).toggleClass("active-shift"),$("#shift_btn_area").slideToggle(),k.render_shift_btn(g.shift_status)}),$(document).on("click",".shift-btn",function(){k.render_shift_btn($(this).text()),k.render_modal_check()}),$(document).on("input","#shift_rest_range",function(){var e=$(this).val();k.render_shift_rest_btn(e)}),$(document).on("click",".rs_btn",function(){var e=$(this).attr("data-time");k.render_shift_rest_btn(e)}),$(document).on("click","#picker_shift_del_in_time",function(){c.clear(),k.render_modal_check()}),$(document).on("click","#picker_shift_del_out_time",function(){h.clear(),k.render_modal_check()}),$(document).on("click","#time_edit_submit",function(){p.save_data().done(function(e){"ok"===e.message?($("#modal2").iziModal("close"),k.show_toast(e.today+" 修正登録 "+g.user_name+" "+e.user_id),k.renderTableData()):k.show_err_toast("通信エラー")}).fail(function(){k.show_err_toast("通信エラー")})}),$("#download_btn_excel").on("click",function(){p.downloadData("xlsx")}),$("#download_btn_pdf").on("click",function(){p.downloadData("pdf")})})}();