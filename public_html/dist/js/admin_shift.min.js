!function(){function r(e,t){if((t=(t=(t=(t=(t=(t=t.replace(/YYYY/g,e.getFullYear())).replace(/MM/g,("0"+(e.getMonth()+1)).slice(-2))).replace(/DD/g,("0"+e.getDate()).slice(-2))).replace(/hh/g,("0"+e.getHours()).slice(-2))).replace(/mm/g,("0"+e.getMinutes()).slice(-2))).replace(/ss/g,("0"+e.getSeconds()).slice(-2))).match(/S/g))for(var a=("00"+e.getMilliseconds()).slice(-3),i=t.match(/S/g).length,n=0;n<i;n++)t=t.replace(/S/,a.substring(n,n+1));return t}var n,t,d,s,_,o,u,c,f,l,h,a,m,g=0,b={},p=Cookies.get("shiftUserId"),i=function(){return $.ajax({url:"../data/columns/shift_users",dataType:"json",type:"POST"})},e=function(){return $.ajax({url:"../data/columns/shift_main",dataType:"json",type:"POST"})},v=function(){var e=document.createElement("form"),t=(e.setAttribute("action","../data/admin_shift/downloadCsv"),e.setAttribute("method","post"),e.style.display="none",document.body.appendChild(e),document.createElement("input")),t=(t.setAttribute("type","hidden"),t.setAttribute("name","name"),t.setAttribute("value",$("#user_name").text()),e.appendChild(t),document.createElement("input")),t=(t.setAttribute("type","hidden"),t.setAttribute("name","year"),t.setAttribute("value",r(new Date(h),"YYYY")),e.appendChild(t),document.createElement("input")),t=(t.setAttribute("type","hidden"),t.setAttribute("name","month"),t.setAttribute("value",r(new Date(h),"MM")),e.appendChild(t),document.createElement("input"));t.setAttribute("type","hidden"),t.setAttribute("name","user_id"),t.setAttribute("value",p),e.appendChild(t),e.submit()},w=function(e){var t=new FormData;return t.append("files",e),$.ajax({url:"../data/admin_shift/uploadCsv",dataType:"text",type:"POST",data:t,processData:!1,contentType:!1})},D=function(){return $.ajax({type:"POST",dataType:"json",url:"../data/admin_shift/userData",data:{user_id:p}})},y=function(){return $.ajax({type:"POST",dataType:"json",url:"../data/admin_shift/saveData",data:{user_id:p,dk_date:b.date,in_time:$("#picker_shift_in_time").val(),out_time:$("#picker_shift_out_time").val(),rest:$("#shift_rest_range").val(),status:a,hour:m}})},C=function(){return $.ajax({type:"POST",url:"../data/admin_shift/refRegister",data:{user_id:p,status:a,dk_date:b.date,in_time:$("#picker_shift_in_time").val(),out_time:$("#picker_shift_out_time").val(),rest:$("#shift_rest_range").val(),status:a,hour:m,id:b.id}})},k=function(){return $.ajax({type:"POST",dataType:"json",url:"../data/admin_shift/table_shift_data",data:{year:r(new Date(h),"YYYY"),month:r(new Date(h),"MM"),user_id:p,flag:"cal"}})},x=function(){for(var e=_.getEventSources(),t=e.length,a=0;a<t;a++)e[a].remove()},M=function(){return $.ajax({type:"POST",dataType:"json",url:"../data/admin_shift/calHoriday",data:{year:r(new Date(h),"YYYY"),month:r(new Date(h),"MM")}})},T=function(){return $.ajax({type:"POST",dataType:"json",url:"../data/admin_shift/workStatus",data:{year:r(new Date(h),"YYYY"),month:r(new Date(h),"MM"),user_id:p}})},Y=function(){return $.ajax({type:"POST",dataType:"json",url:"../data/admin_shift/registerStatus",data:{user_id:p,year:r(new Date(h),"YYYY"),month:r(new Date(h),"MM"),flag:"admin"}})},S=function(){return $.ajax({type:"POST",url:"../data/admin_shift/refRegisterAll",data:{user_id:p,year:r(new Date(h),"YYYY"),month:r(new Date(h),"MM")}})},F=function(){return $.ajax({type:"POST",url:"../data/admin_shift/allData",data:{filterUserData:o,year:r(new Date(h),"YYYY"),month:r(new Date(h),"MM")}})};const E={renderDate:new Promise(function(e,t){(h=(l=flatpickr("#month",{plugins:[new monthSelectPlugin({dateFormat:"Y年m月",theme:"light"})],defaultDate:"today",onChange:function(){h=l.selectedDates[0],E.renderDateText(h),E.renderUsersTableData(),0===shift_view_flag&&E.renderShiftTableData(),1===shift_view_flag&&(_.gotoDate(h),E.render_cal_data(),E.rendar_cal_holiday())}})).selectedDates[0]).setDate(1),e()}),renderDateText:function(e){l.setDate(e);var t=r(new Date(e),"YYYY年MM月")+"01日",a=r(new Date(e.getFullYear(),e.getMonth()+1,0),"YYYY年MM月DD日"),i=new Date(e.getFullYear(),e.getMonth()+1,0),i=(s=i.getDate(),$("#to_from_date").text(t+"から"+a+"までの"+s+"日間"),new Intl.DateTimeFormat("ja-JP-u-ca-japanese",{era:"long",year:"numeric"}).format(new Date(e))),t=($("#date-area-wareki").text(i),new Date),a=t.getFullYear(),i=t.getMonth(),t=new Date(e),n=t.getFullYear(),t=t.getMonth(),a=new Date(a,i),i=new Date(n,t),n=a.getMonth()-i.getMonth()+12*(a.getFullYear()-i.getFullYear());0==n?($("#this_month").addClass("disable"),$("#this_month_mark").addClass("this-month"),$("#this_month_mark").text("今月")):($("#this_month").removeClass("disable"),$("#this_month_mark").removeClass("this-month"),0<n?$("#this_month_mark").text(n+"ヶ月前"):$("#this_month_mark").text(Math.abs(n)+"ヶ月後")),Cookies.set("shiftMonth",e)},renderUsersTableColumns:new Promise(function(t,e){i().done(function(e){n=new Tabulator("#users_table",{height:500,columns:e,selectable:!0,rowFormatter:function(e){0<e.getData().shift&&(e.getElement().style.color="#f9ae00",e.getElement().style.fontWeight="bold"),e.getData().shift==s&&(e.getElement().style.color="#1c1cff",e.getElement().style.fontWeight="bold"),0<e.getData().register&&(e.getElement().style.backgroundColor="rgba(252, 168, 168, 0.5)")},rowClick:function(e,t){t=t.getData();p===t.user_id?E.render_del_select():(p=t.user_id,Cookies.set("shiftUserId",p),$("#user_select_disable").removeClass("disabled").addClass("on")),0===shift_view_flag&&E.renderShiftTableData(),1===shift_view_flag&&E.render_cal_data(),E.render_all()},dataFiltered:function(e,t){var a=[];if(o=[],0<t.length){for(var i=0;i<t.length;i++)a.push(t[i]._row.data);$.each(a,function(e,t){o.push(t.user_id)})}E.render_all()},invalidOptionWarnings:!1}),t(),n.toggleColumn("group1_name"),n.toggleColumn("group2_name"),n.toggleColumn("group3_name"),n.hideColumn("shift"),n.hideColumn("register")})}),renderShiftTableColumns:function(){e().done(function(e){t=new Tabulator("#shift_table",{height:"100%",columns:e,placeholder:"従業員を選択",resizableColumns:!1,rowFormatter:function(e){"shift_today"===e.getData().dateView&&(e.getElement().style.background="#fcf8e3"),"shift_past"===e.getData().dateView&&(e.getElement().style.background="#f4f4f4")},tooltips:function(e){var t=e.getValue();"日"!=t&&"祝"!=t||(e.getElement().style.color="#F44336"),"土"==t&&(e.getElement().style.color="#0D47A1"),"出勤"==t&&(e.getElement().style.color="#9abcea"),"公休"==t&&(e.getElement().style.color="#F44336"),"未登録"==t&&(e.getElement().style.color="#ccc"),"有給"==t&&(e.getElement().style.color="#fff",e.getElement().style.background="#40a598")},rowClick:function(e,t){2!==authority&&(b=t.getData(),E.render_modal(b))},invalidOptionWarnings:!1}),E.renderShiftTableData()})},renderUsersTableData:function(){n.replaceData("../data/admin_shift/table_users_data",{year:r(new Date(h),"YYYY"),month:r(new Date(h),"MM")},"POST")},renderShiftTableData:function(){t.clearData(),p&&(t.replaceData("../data/admin_shift/table_shift_data",{year:r(new Date(h),"YYYY"),month:r(new Date(h),"MM"),user_id:p,flag:"list"},"POST"),E.renderUserData(),t.hideColumn("date"))},renderUserData:function(){D(p).done(function(e){$("#user_name").text(e.user_name),$("#user_id").text(p),$("#group1_name").text(e.group1_name),$("#group2_name").text(e.group2_name),$("#group3_name").text(e.group3_name),n.deselectRow(),n.selectRow(p)})},show_toast:function(e){siiimpleToast.message(e,{position:"top|right"})},show_err_toast:function(e){siiimpleToast.alert(e,{position:"top|right"})},render_modal:function(e){g=0,$("#shift_btn_area").show(),$("#time_edit_submit").text("登録").removeClass("regidter"),$("#shift_date").text(e.dateW);var t=e.in_time||"",t=(timepicker_shift_in=flatpickr("#picker_shift_in_time",{enableTime:!0,noCalendar:!0,dateFormat:"H:i",time_24hr:!0,defaultHour:defaultInHour,defaultMinute:defaultInMinute,minuteIncrement:defaultMinuteIncrement,defaultDate:t,onChange:function(){E.render_modal_check()},onClose:function(){E.render_modal_check()}}),timepicker_shift_out=flatpickr("#picker_shift_out_time",{enableTime:!0,noCalendar:!0,dateFormat:"H:i",time_24hr:!0,defaultHour:defaultOutHour,defaultMinute:defaultOutMinute,minuteIncrement:defaultMinuteIncrement,defaultDate:e.out_time,onChange:function(){E.render_modal_check()},onClose:function(){E.render_modal_check()}}),$(".iziModal-header-title").text($("#user_name").text()),$("#group1_name").text()),a=$("#group2_name").text(),i=$("#group3_name").text(),t=($(".iziModal-header-subtitle").text("ID："+p+"　"+t+"　"+a+"　"+i),e.in_time||"--"),a=($("#shift_in_time").text(t),e.out_time||"--"),i=($("#shift_out_time").text(a),e.hour2?e.hour2+"分":"--"),t=($("#shift_value").text(i),e.hour||""),a=($("#shift_value2").text(t),E.render_shift_btn(e.status),$("#shift_rest_range").prop("disabled",!1).val(Number(e.rest)),e.rest2||0),i=(E.render_shift_rest_btn(a),e.rest||"0:00");$("#rest_value2").text(i),"register"===e.flag&&($(".iziModal-header-title").text($("#user_name").text()+" の申請"),$(".iziModal-header-subtitle").text("申請の反映登録をおこないます"),$("#time_edit_submit").text("反映").addClass("regidter"),$("#modal2").iziModal("setIcon","icon-notice"),$("#modal2").iziModal("setHeaderColor","#464646"),g=1,E.render_modal_check()),$("#time_edit_submit").attr("data-user-id",p),$("#modal2").iziModal("open")},render_shift_rest_btn:function(e){$(".rs_btn").removeClass("active"),$("#shift_rest_"+e).addClass("active"),$("#shift_memori_"+e).addClass("active"),$("#shift_rest_value").text(e+"分");var t=e/60,a=Math.floor(t),t=Math.round(60*(t-a));$("#shift_rest_value2").text(a+":"+("0"+t).slice(-2)),$("#shift_rest_range").val(e),E.render_modal_check()},render_shift_btn:function(e){var t;$(".shift-btn").removeClass("disabled"),$("#shift_time_edit_area").hide(),"未登録"!==e&&""!==e||($("#state_none").addClass("disabled"),d='未登録<div class="shift-date">'+b.dateW+"</div>",t="#ccc",a="del"),"出勤"===e&&($("#state_work").addClass("disabled"),d="出勤",t="#3788d8",a=0,$("#shift_time_edit_area").show()),"公休"===e&&($("#state_rest").addClass("disabled"),d='公休<div class="shift-date">'+b.dateW+"</div>",a=1,t="#ff7d73"),"有給"===e&&($("#state_raid").addClass("disabled"),d='有給<div class="shift-date">'+b.dateW+"</div>",a=2,t="#40a598"),$("#status_name").html("シフト "+d).css("color",t),$("#modal2").iziModal("setHeaderColor",t),E.render_modal_check()},render_modal_check:function(){if($("#time_edit_submit").addClass("disable"),$(".time-input, .shift-rest-value").removeClass("error"),$("#shift_value").text("--"),$("#shift_value2").text(""),"出勤"===d){var e,t=new Date(timepicker_shift_in.selectedDates).getHours(),a=60*t+new Date(timepicker_shift_in.selectedDates).getMinutes(),i=new Date(timepicker_shift_out.selectedDates).getHours(),n=60*i+new Date(timepicker_shift_out.selectedDates).getMinutes(),r=$("#picker_shift_in_time").val(),s=$("#picker_shift_out_time").val();if(0<over_day&&(t<=over_day&&(a+=1440,l=r.substr(0,2),e=r.substr(-2),r=(l=Number(l)+24)+":"+e),i<=over_day&&(n+=1440,l=s.substr(0,2),e=s.substr(-2),s=(l=Number(l)+24)+":"+e)),!a)return void $("#picker_shift_in_time").addClass("error");if(!n)return void $("#picker_shift_out_time").addClass("error");if(a&&n){var o=$("#shift_rest_range").val();if((m=n-a)-o<=0)return void $("#picker_shift_out_time").addClass("error");if(m<=o)return void $(".shift-rest-value").addClass("error");m-=o,$("#shift_value").text(m+"分");var t=m/60,i=Math.floor(t),l=Math.round(60*(t-i));$("#shift_value2").text(i+":"+("0"+l).slice(-2))}}b.status!=d&&$("#time_edit_submit").removeClass("disable"),"出勤"===d&&(b.in_time!=r&&$("#time_edit_submit").removeClass("disable"),b.out_time!=s&&$("#time_edit_submit").removeClass("disable"),(b.rest2||0)!=o&&$("#time_edit_submit").removeClass("disable"),1===g&&$("#time_edit_submit").removeClass("disable"))},render_calendar:function(){var e=document.getElementById("shift_table");(_=new FullCalendar.Calendar(e,{plugins:["dayGrid"],timeZone:"local",defaultView:"dayGridMonth",locale:"ja",defaultDate:new Date(h),firstDay:shift_cal_first_day,header:{left:"",center:"",right:""},eventClick:function(e){$(".fc-day-grid-event").css("opacity",1),e.el.style.opacity=.5,2!==authority&&(b=e.event.extendedProps,E.render_modal(b))}})).render(),E.render_cal_data(),E.rendar_cal_holiday()},rendar_cal_holiday:function(){M().done(function(e){$(".holiday").html(""),$.each(e,function(e,t){$('.fc-day-top[data-date="'+t.date+'"]').prepend('<span class="holiday">'+t.holiday+"</span>"),t.holiday&&$('.fc-day-top[data-date="'+t.date+'"] > .fc-day-number').css("color","#ff7d73")})})},render_cal_data:function(){E.renderUserData(),x(),p&&T().done(function(e){_.addEventSource(e),k().done(function(e){_.addEventSource(e),Y().done(function(e){_.addEventSource(e),E.rendar_register_submit_btn(e.length)})})})},rendar_register_submit_btn:function(e){$("#register_submit_btn").addClass("disabled"),0<e&&$("#register_submit_btn").removeClass("disabled")},render_all:function(){F().done(function(e){var r,s,o,l;0!==e.length&&(r=[],l=o=s=0,$.each(e,function(e,t){var a=0,i=0,t=($.each(t,function(e,t){if(p&&Number(p)!=e)return!0;0<t.hour&&(a+=t.hour,i++,o+=t.hour,l++)}),Math.floor(a/60)),n=t+":"+("0"+a%60).slice(-2);1!==shift_view_flag||p||(t=0<t?i+"人 合計時間 "+n:"",r[s]={title:t,start:e,color:"rgba(255, 255, 255, 0)",textColor:"#1b97a8",classNames:"work-status"}),s++}),1!==shift_view_flag||p||(x(),_.addEventSource(r)),e=Math.floor(o/60)+":"+("0"+o%60).slice(-2),p||(n.deselectRow(),$("#user_time_data").html(""),$("#user_name").html(""),$("#user_id").text(""),$("#group1_name").text(""),$("#group2_name").text(""),$("#group3_name").text(""),$("#user_name").html('<i class="fas fa-users"></i> 稼働合計人数：'+l+'人 <i class="fas fa-clock"></i> 合計時間：'+e),$("#group1_name").text(u),$("#group2_name").text(c),$("#group3_name").text(f)),p&&$("#user_time_data").html('<i class="fas fa-walking"></i> シフト日数：'+l+'日 <i class="fas fa-clock"></i> 合計シフト時間：'+e))})},render_del_select:function(){o=[],f=c=u=p="",Cookies.remove("shiftUserId"),$("#user_select_disable").addClass("disabled").removeClass("on"),$("#register_submit_btn").addClass("disabled"),E.renderUsersTableData(),0===shift_view_flag&&E.renderShiftTableData(),1===shift_view_flag&&E.render_cal_data()}};$(function(){function e(e){h=e?new Date(h.setMonth(h.getMonth()+e)):new Date,E.renderDateText(h),E.renderUsersTableData(),0===shift_view_flag&&E.renderShiftTableData(),1===shift_view_flag&&(-1===e&&_.prev(),1===e&&_.next(),e||_.today(),E.render_cal_data(),E.rendar_cal_holiday())}Promise.all([E.renderUsersTableColumns,E.renderDate]).then(function(){E.renderUsersTableData(),E.renderDateText(h),E.render_all(),0===shift_view_flag&&($("#register_submit_btn").hide(),E.renderShiftTableColumns()),1===shift_view_flag&&($("#register_submit_btn").show(),E.render_calendar())}),p&&$("#user_select_disable").removeClass("disabled").addClass("on"),2===authority&&($("#csv_download_btn").addClass("disabled"),$(".up-file").addClass("disabled")),$("#modal2").iziModal({headerColor:"#1591a2",focusInput:!1,width:700}),$("#less_month").on("click",function(){e(-1)}),$("#add_month").on("click",function(){e(1)}),$("#this_month_mark, #this_month").on("click",function(){e()}),$("#csv_download_btn").on("click",function(){v()}),$('input[type="file"]').on("change",function(){var e=$(this).prop("files");if(0<e.length){$("#loader").show();for(var t=0;t<e.length;t++)w(e[t]).done(function(e){$("#loader").hide(),E.show_toast("シフト登録 "+e),E.renderUsersTableData(),0===shift_view_flag&&E.renderShiftTableData(),1===shift_view_flag&&(E.render_cal_data(),E.rendar_cal_holiday())})}}),$("#users_table_btn").on("click",function(){$("#users_table_area").toggleClass("detaile_view"),$(this).toggleClass("on"),n.toggleColumn("group1_name"),n.toggleColumn("group2_name"),n.toggleColumn("group3_name")}),$(document).on("input change",".time-val",function(){E.render_modal_check()}),$(document).on("click","#picker_shift_del_in_time",function(){timepicker_shift_in.clear(),E.render_modal_check()}),$(document).on("click","#picker_shift_del_out_time",function(){timepicker_shift_out.clear(),E.render_modal_check()}),$(document).on("click",".shift-btn",function(){E.render_shift_btn($(this).text())}),$(document).on("input","#shift_rest_range",function(){var e=$(this).val();E.render_shift_rest_btn(e)}),$(document).on("click",".rs_btn",function(){var e=$(this).attr("data-time");E.render_shift_rest_btn(e)}),$(document).on("click","#time_edit_submit",function(){$("#time_edit_submit").addClass("disable"),0===g&&y().done(function(e){"ok"===e.message?($("#modal2").iziModal("close"),E.show_toast(e.today+" 修正登録 "+$("#user_name").text()+" "+e.user_id),E.renderUsersTableData(),0===shift_view_flag&&E.renderShiftTableData(),1===shift_view_flag&&E.render_cal_data()):E.show_err_toast("通信エラー")}).fail(function(){E.show_err_toast("通信エラー")}),1===g&&C().done(function(e){"ok"===e?($("#modal2").iziModal("close"),E.show_toast("申請シフト反映"),E.renderUsersTableData(),0===shift_view_flag&&E.renderShiftTableData(),1===shift_view_flag&&E.render_cal_data()):E.show_err_toast("通信エラー")}).fail(function(){E.show_err_toast("通信エラー")})});const t=$("#register_submit_btn"),a=$("#shift_table"),i=$("#shift_view_title");$("#shift_view_change").on("click",function(){a.empty(),shift_view_flag=0===shift_view_flag?(t.show(),a.removeClass("tabulator"),i.html('<i class="far fa-calendar"></i> カレンダー'),E.render_calendar(),1):(t.hide(),a.removeClass("fc fc-ltr fc-unthemed"),x(),E.renderShiftTableColumns(),i.html('<i class="fas fa-list"></i> リスト'),0),E.renderUsersTableData()}),$("#register_submit_btn").on("click",function(){$(this).addClass("disabled"),S().done(function(e){$.each(e,function(e,t){"ok"==t.message?E.show_toast("申請シフト反映 "+t.dk_date):E.show_err_toast("反映エラー"+t.dk_date)}),E.renderUsersTableData(),E.render_cal_data()}).fail(function(){E.show_err_toast("通信エラー")})}),$("#select_group_1").on("change",function(){n.removeFilter("group1_name","=",u),"ALL"!==(u=$(this).val())&&n.addFilter("group1_name","=",u)}),$("#select_group_2").on("change",function(){n.removeFilter("group2_name","=",c),"ALL"!==(c=$(this).val())&&n.addFilter("group2_name","=",c)}),$("#select_group_3").on("change",function(){n.removeFilter("group3_name","=",f),"ALL"!==(f=$(this).val())&&n.addFilter("group3_name","=",f)}),$("#shift_status").on("change",function(){n.removeFilter("shift","=",0),n.removeFilter("shift",">",0),n.removeFilter("shift","=",s),n.removeFilter("shift","!=",s);var e=$(this).val();0==e&&n.addFilter("shift","=",0),1==e&&(n.addFilter("shift",">",0),n.addFilter("shift","!=",s)),2==e&&n.addFilter("shift","=",s)}),$("#user_select_disable").on("click",function(){E.render_del_select()})})}();