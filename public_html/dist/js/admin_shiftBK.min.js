!function(){function l(e,t){if((t=(t=(t=(t=(t=(t=t.replace(/YYYY/g,e.getFullYear())).replace(/MM/g,("0"+(e.getMonth()+1)).slice(-2))).replace(/DD/g,("0"+e.getDate()).slice(-2))).replace(/hh/g,("0"+e.getHours()).slice(-2))).replace(/mm/g,("0"+e.getMinutes()).slice(-2))).replace(/ss/g,("0"+e.getSeconds()).slice(-2))).match(/S/g))for(var a=("00"+e.getMilliseconds()).slice(-3),i=t.match(/S/g).length,n=0;n<i;n++)t=t.replace(/S/,a.substring(n,n+1));return t}function t(e,t,a){switch(a){case"YYYY":e.setYear(e.getYear()+t);break;case"MM":e.setMonth(e.getMonth()+t);break;case"hh":e.setHours(e.getHours()+t);break;case"mm":e.setMinutes(e.getMinutes()+t);break;case"ss":e.setSeconds(e.getSeconds()+t);break;default:e.setDate(e.getDate()+t)}return e}var a,i,n,s,d,r,_,u,c,o,m,h=0,f=Cookies.get("shiftUserId"),e=function(){return $.ajax({url:"../data/columns/shift_users",dataType:"json",type:"POST"})},g=function(){return $.ajax({url:"../data/columns/shift_main",dataType:"json",type:"POST"})},b=function(){var e=document.createElement("form"),t=(e.setAttribute("action","../data/admin_shift/downloadCsv"),e.setAttribute("method","post"),e.style.display="none",document.body.appendChild(e),document.createElement("input")),t=(t.setAttribute("type","hidden"),t.setAttribute("name","name"),t.setAttribute("value",$("#user_name").text()),e.appendChild(t),document.createElement("input")),t=(t.setAttribute("type","hidden"),t.setAttribute("name","year"),t.setAttribute("value",l(new Date(m),"YYYY")),e.appendChild(t),document.createElement("input")),t=(t.setAttribute("type","hidden"),t.setAttribute("name","month"),t.setAttribute("value",l(new Date(m),"MM")),e.appendChild(t),document.createElement("input"));t.setAttribute("type","hidden"),t.setAttribute("name","user_id"),t.setAttribute("value",f),e.appendChild(t),e.submit()},p=function(e){var t=new FormData;return t.append("files",e),$.ajax({url:"../data/admin_shift/uploadCsv",dataType:"text",type:"POST",data:t,processData:!1,contentType:!1})},v=function(){return $.ajax({type:"POST",dataType:"json",url:"../data/gateway/mail_time_val"})},w=function(){return $.ajax({type:"POST",dataType:"json",url:"../data/admin_shift/userData",data:{user_id:f}})},D=function(){return $.ajax({type:"POST",dataType:"json",url:"../data/admin_shift/saveData",data:{user_id:f,status:n,dk_date:$("#time_edit_submit").attr("data-date"),in_time_h:$("#select-in_hour").val(),in_time_m:$("#select-in_min").val(),out_time_h:$("#select-out_hour").val(),out_time_m:$("#select-out_min").val(),rest:$("#rest_range").val()}})},y=function(){return $.ajax({type:"POST",dataType:"json",url:"../data/admin_shift/table_shift_data",data:{year:l(new Date(m),"YYYY"),month:l(new Date(m),"MM"),user_id:f,flag:"cal"}})},C=function(){for(var e=d.getEventSources(),t=e.length,a=0;a<t;a++)e[a].remove()},Y=function(){return $.ajax({type:"POST",dataType:"json",url:"../data/admin_shift/calHoriday",data:{year:l(new Date(m),"YYYY"),month:l(new Date(m),"MM")}})},M=function(){return $.ajax({type:"POST",dataType:"json",url:"../data/admin_shift/workStatus",data:{year:l(new Date(m),"YYYY"),month:l(new Date(m),"MM"),user_id:f}})},T=function(){return $.ajax({type:"POST",dataType:"json",url:"../data/admin_shift/registerStatus",data:{user_id:f,year:l(new Date(m),"YYYY"),month:l(new Date(m),"MM"),flag:"admin"}})},x=function(){return $.ajax({type:"POST",url:"../data/admin_shift/refRegister",data:{user_id:f,status:n,dk_date:$("#time_edit_submit").attr("data-date"),in_time_h:$("#select-in_hour").val(),in_time_m:$("#select-in_min").val(),out_time_h:$("#select-out_hour").val(),out_time_m:$("#select-out_min").val()}})},k=function(){return $.ajax({type:"POST",url:"../data/admin_shift/refRegisterAll",data:{user_id:f,year:l(new Date(m),"YYYY"),month:l(new Date(m),"MM")}})},S=function(){return $.ajax({type:"POST",url:"../data/admin_shift/allData",data:{filterUserData:r,year:l(new Date(m),"YYYY"),month:l(new Date(m),"MM")}})},F={renderDate:function(){(m=(o=flatpickr("#month",{plugins:[new monthSelectPlugin({dateFormat:"Y年m月",theme:"light"})],defaultDate:"today",onChange:function(){m=o.selectedDates[0],F.renderDateText(m),F.renderUsersTableData(),0===shift_view_flag&&F.renderShiftTableData(),1===shift_view_flag&&(d.gotoDate(m),F.render_cal_data(),F.rendar_cal_holiday())}})).selectedDates[0]).setDate(1),Cookies.get("shiftMonth")&&(m=new Date(Cookies.get("shiftMonth")),F.renderDateText(m))},renderDateText:function(e){o.setDate(e);var t=l(new Date(e),"YYYY年MM月")+"01日",a=l(new Date(e.getFullYear(),e.getMonth()+1,0),"YYYY年MM月DD日"),i=new Date(e.getFullYear(),e.getMonth()+1,0),i=(s=i.getDate(),$("#to_from_date").text(t+"から"+a+"までの"+s+"日間"),new Intl.DateTimeFormat("ja-JP-u-ca-japanese",{era:"long",year:"numeric"}).format(new Date(e))),t=($("#date-area-wareki").text(i),new Date),a=t.getFullYear(),i=t.getMonth(),t=new Date(e),n=t.getFullYear(),t=t.getMonth(),a=new Date(a,i),i=new Date(n,t),n=a.getMonth()-i.getMonth()+12*(a.getFullYear()-i.getFullYear());0==n?($("#this_month").addClass("disable"),$("#this_month_mark").addClass("this-month"),$("#this_month_mark").text("今月")):($("#this_month").removeClass("disable"),$("#this_month_mark").removeClass("this-month"),0<n?$("#this_month_mark").text(n+"ヶ月前"):$("#this_month_mark").text(Math.abs(n)+"ヶ月後")),Cookies.set("shiftMonth",e)},renderUsersTableColumns:function(){e().done(function(e){a=new Tabulator("#users_table",{height:500,columns:e,selectable:!0,rowFormatter:function(e){0<e.getData().shift&&(e.getElement().style.color="#f9ae00",e.getElement().style.fontWeight="bold"),e.getData().shift==s&&(e.getElement().style.color="#1c1cff",e.getElement().style.fontWeight="bold"),0<e.getData().register&&(e.getElement().style.backgroundColor="rgba(252, 168, 168, 0.5)")},rowClick:function(e,t){t=t.getData();f===t.user_id?F.render_del_select():(f=t.user_id,Cookies.set("shiftUserId",f),$("#user_select_disable").removeClass("disabled").addClass("on")),0===shift_view_flag&&F.renderShiftTableData(),1===shift_view_flag&&F.render_cal_data()},dataFiltered:function(e,t){var a=[];if(r=[],0<t.length){for(var i=0;i<t.length;i++)a.push(t[i]._row.data);$.each(a,function(e,t){r.push(t.user_id)})}F.render_all()},invalidOptionWarnings:!1}),F.renderUsersTableData(),a.toggleColumn("group1_name"),a.toggleColumn("group2_name"),a.toggleColumn("group3_name"),a.hideColumn("shift"),a.hideColumn("register")})},renderShiftTableColumns:function(){g().done(function(e){i=new Tabulator("#shift_table",{height:"100%",columns:e,placeholder:"従業員を選択",resizableColumns:!1,rowFormatter:function(e){"shift_today"===e.getData().date&&(e.getElement().style.background="#fcf8e3"),"shift_past"===e.getData().date&&(e.getElement().style.background="#f4f4f4")},tooltips:function(e){var t=e.getValue();"日"!=t&&"祝"!=t||(e.getElement().style.color="#F44336"),"土"==t&&(e.getElement().style.color="#0D47A1"),"出勤"==t&&(e.getElement().style.color="#9abcea"),"公休"==t&&(e.getElement().style.color="#F44336"),"未登録"==t&&(e.getElement().style.color="#ccc"),"有給"==t&&(e.getElement().style.color="#fff",e.getElement().style.background="#40a598")},rowClick:function(e,t){2!==authority&&(t=t.getData(),F.render_modal(t))},invalidOptionWarnings:!1}),F.renderShiftTableData()})},renderUsersTableData:function(){a.clearData(),a.replaceData("../data/admin_shift/table_users_data",{year:l(new Date(m),"YYYY"),month:l(new Date(m),"MM")},"POST")},renderShiftTableData:function(){i.clearData(),f&&(i.replaceData("../data/admin_shift/table_shift_data",{year:l(new Date(m),"YYYY"),month:l(new Date(m),"MM"),user_id:f,flag:"list"},"POST"),F.renderUserData(),F.render_all(),i.hideColumn("date"))},renderUserData:function(){w(f).done(function(e){$("#user_name").text(e.user_name),$("#user_id").text(f),$("#group1_name").text(e.group1_name),$("#group2_name").text(e.group2_name),$("#group3_name").text(e.group3_name),a.deselectRow(),a.selectRow(f)})},show_toast:function(e){siiimpleToast.message(e,{position:"top|right"})},show_err_toast:function(e){siiimpleToast.alert(e,{position:"top|right"})},render_time_val:function(e){v().done(function(e){$(".time-hour, .time-min").html(""),$(".time-hour").append('<option value="">--</option>'),$(".time-min").append('<option value="">--</option><option value="0">00</option><option value="15">15</option><option value="30">30</option><option value="45">45</option>'),$.each(e.hour,function(e,t){var a=("0"+t).slice(-2);$(".time-hour").append('<option value="'+t+'">'+a+"</option>")})})},render_modal:function(e){$("#shift_btn_area").show();var t,a,i,n="",s="",r="";h=0,$("#time_edit_submit").text("登録"),$("#time_edit_submit").css("background-color","#1591a2"),0==shift_view_flag&&($("#modal_date").text($("#month").val()+e.day+"日("+e.week+")"),e.in_time&&(n=e.in_time),e.out_time&&(s=e.out_time),e.rest2&&(r=e.rest2),F.render_shift_btn(e.status),a=l(new Date(Cookies.get("shiftMonth")),"YYYY-MM"),$("#time_edit_submit").attr("data-date",a+"-"+e.day)),1==shift_view_flag&&(i=l(new Date(e.event.start),"YYYY年MM月DD日"),t=["（日）","（月）","（火）","（水）","（木）","（金）","（土）"][new Date(e.event.start).getDay()],$("#modal_date").text(i+t),i=e.event.id,t=e.event.title,1<i.length&&(n=i.slice(0,5),s=i.slice(-5),t="出勤"),F.render_shift_btn_cal(t),a=l(new Date(e.event.start),"YYYY-MM-DD"),$("#time_edit_submit").attr("data-date",a)),n?($("#in_time").text(n),$('#select-in_hour > option[value="'+Number(n.slice(0,2))+'"]').prop("selected",!0),$('#select-in_min > option[value="'+Number(n.slice(-2))+'"]').prop("selected",!0)):($("#in_time").text("--"),$("#select-in_hour").val(""),$("#select-in_min").val("")),s?($("#out_time").text(s),$('#select-out_hour > option[value="'+Number(s.slice(0,2))+'"]').prop("selected",!0),$('#select-out_min > option[value="'+Number(s.slice(-2))+'"]').prop("selected",!0)):($("#out_time").text("--"),$("#select-out_hour").val(""),$("#select-out_min").val("")),$("#rest_range").prop("disabled",!1),$("#rest_range").val(Number(e.rest2)),$(".rest-btn-area").show(),F.render_rest_btn(i=""==r?0:r),$("#rest_value").text(i+"分"),$(".iziModal-header-title").text($("#user_name").text()),$(".iziModal-header-subtitle").text("シフト修正"),$("#modal2").iziModal("setIcon","icon-shift"),1===shift_view_flag&&e.el.classList.contains("register")&&($(".iziModal-header-title").text($("#user_name").text()+" の申請"),$(".iziModal-header-subtitle").text("申請の反映登録をおこないます"),$("#time_edit_submit").removeClass("disable"),$("#time_edit_submit").text("反映"),$("#time_edit_submit").css("background-color","#464646"),$("#modal2").iziModal("setIcon","icon-notice"),$("#modal2").iziModal("setHeaderColor","#464646"),h=1),$("#modal2").iziModal("open")},render_rest_btn:function(e){$(".r_btn").removeClass("active"),$("#rest_"+e).addClass("active")},render_shift_btn:function(e){$(".rest-time-area").hide();var t="#3788d8";switch(e){case"未登録":$(".shift-btn").removeClass("disabled"),$(".time_edit_area").hide(),t="#ccc";break;case"出勤":$(".shift-btn").removeClass("disabled"),$("#state_work").addClass("disabled"),$(".time_edit_area").show(),n=0;break;case"公休":$(".shift-btn").removeClass("disabled"),$("#state_rest").addClass("disabled"),$(".time_edit_area").hide(),n=1,t="#ff7d73";break;case"有給":$(".shift-btn").removeClass("disabled"),$("#state_raid").addClass("disabled"),$(".time_edit_area").hide(),n=2,t="#40a598";break;default:$(".shift-btn").removeClass("disabled"),$(".time_edit_area").hide()}$("#status_name").text(e),$("#status_name").css("color",t),$("#modal2").iziModal("setHeaderColor",t)},render_shift_btn_cal:function(e){$(".rest-time-area").hide(),$(".shift-btn").removeClass("disabled"),$("#state_work").addClass("disabled"),$(".time_edit_area").show(),n=0;var t="#3788d8";"未登録"!==e&&"・未登録"!==e||($(".shift-btn").removeClass("disabled"),$(".time_edit_area").hide(),e="未登録",t="#ccc"),"公休"!==e&&"・公休"!==e||($(".shift-btn").removeClass("disabled"),$("#state_rest").addClass("disabled"),$(".time_edit_area").hide(),n=1,e="公休",t="#ff7d73"),"有給"!==e&&"・有給"!==e||($(".shift-btn").removeClass("disabled"),$("#state_raid").addClass("disabled"),$(".time_edit_area").hide(),n=2,e="有給",t="#40a598"),$("#status_name").text(e),$("#status_name").css("color",t),$("#modal2").iziModal("setHeaderColor",t)},render_calendar:function(){var e=document.getElementById("shift_table");(d=new FullCalendar.Calendar(e,{plugins:["dayGrid"],timeZone:"local",defaultView:"dayGridMonth",locale:"ja",defaultDate:new Date(m),firstDay:shift_cal_first_day,header:{left:"",center:"",right:""},eventClick:function(e){$(".fc-day-grid-event").css("opacity",1),e.el.style.opacity=.5,2!==authority&&F.render_modal(e)}})).render(),F.render_cal_data(),F.rendar_cal_holiday()},rendar_cal_holiday:function(){Y().done(function(e){$(".holiday").html(""),$.each(e,function(e,t){$('.fc-day-top[data-date="'+t.date+'"]').prepend('<span class="holiday">'+t.holiday+"</span>"),t.holiday&&$('.fc-day-top[data-date="'+t.date+'"] > .fc-day-number').css("color","#ff7d73")})})},render_cal_data:function(){C(),f&&M().done(function(e){d.addEventSource(e),y().done(function(e){d.addEventSource(e),T().done(function(e){d.addEventSource(e),F.renderUserData(),F.rendar_register_submit_btn(e.length)})})}),F.render_all()},rendar_register_submit_btn:function(e){$("#register_submit_btn").addClass("disabled"),0<e&&$("#register_submit_btn").removeClass("disabled")},render_all:function(){S().done(function(e){var s,r,l,o;0!==e.length&&(s=[],o=l=r=0,$.each(e,function(e,t){var a=0,i=0,t=($.each(t,function(e,t){if(f&&Number(f)!=e)return!0;0<t.hour&&(a+=t.hour,i++,l+=t.hour,o++)}),Math.floor(a/60)),n=t+":"+("0"+a%60).slice(-2);1!==shift_view_flag||f||(t=0<t?i+"人 合計時間 "+n:"",s[r]={title:t,start:e,color:"rgba(255, 255, 255, 0)",textColor:"#1b97a8",classNames:"work-status"}),r++}),1!==shift_view_flag||f||(C(),d.addEventSource(s)),e=Math.floor(l/60)+":"+("0"+l%60).slice(-2),f||($("#user_time_data").html(""),$("#user_name").html(""),$("#user_id").text(""),$("#group1_name").text(""),$("#group2_name").text(""),$("#group3_name").text(""),$("#user_name").html('<i class="fas fa-users"></i> 稼働合計人数：'+o+'人 <i class="fas fa-clock"></i> 合計時間：'+e),$("#group1_name").text(_),$("#group2_name").text(u),$("#group3_name").text(c)),f&&$("#user_time_data").html('<i class="fas fa-walking"></i> シフト日数：'+o+'日 <i class="fas fa-clock"></i> 合計シフト時間：'+e))})},render_del_select:function(){r=[],c=u=_=f="",Cookies.remove("shiftUserId"),$("#user_select_disable").addClass("disabled").removeClass("on"),$("#register_submit_btn").addClass("disabled"),F.renderUsersTableData(),0===shift_view_flag&&F.renderShiftTableData(),1===shift_view_flag&&F.render_cal_data()}};$(function(){F.renderDate(),F.renderDateText(m),F.render_time_val(),F.renderUsersTableColumns(),0===shift_view_flag&&($("#register_submit_btn").hide(),F.renderShiftTableColumns()),1===shift_view_flag&&($("#register_submit_btn").show(),F.render_calendar()),f&&$("#user_select_disable").removeClass("disabled").addClass("on"),$("#modal2").iziModal({headerColor:"#1591a2",onClosed:function(){$("#time_edit_submit").addClass("disable")}}),$("#less_month").on("click",function(e){m=t(new Date(m),-1,"MM"),F.renderDateText(m),F.renderUsersTableData(),0===shift_view_flag&&F.renderShiftTableData(),1===shift_view_flag&&(d.prev(),F.render_cal_data(),F.rendar_cal_holiday())}),$("#add_month").on("click",function(e){m=t(new Date(m),1,"MM"),F.renderDateText(m),F.renderUsersTableData(),0===shift_view_flag&&F.renderShiftTableData(),1===shift_view_flag&&(d.next(),F.render_cal_data(),F.rendar_cal_holiday())}),$("#this_month_mark, #this_month").on("click",function(e){(m=new Date).setDate(1),F.renderDateText(m),F.renderUsersTableData(),0===shift_view_flag&&F.renderShiftTableData(),1===shift_view_flag&&(d.today(),F.render_cal_data(),F.rendar_cal_holiday())}),2===authority&&($("#csv_download_btn").addClass("disabled"),$(".up-file").addClass("disabled")),$("#csv_download_btn").on("click",function(){b()}),$('input[type="file"]').change(function(){$("#loader").show();for(var e=$(this).prop("files"),t=0;t<e.length;t++)p(e[t]).done(function(e){$("#loader").hide(),F.show_toast("シフト登録 "+e),F.renderUsersTableData(),0===shift_view_flag&&F.renderShiftTableData(),1===shift_view_flag&&(F.render_cal_data(),F.rendar_cal_holiday())})}),$("#users_table_btn").on("click",function(){$("#users_table_area").toggleClass("detaile_view"),$(this).toggleClass("on"),a.toggleColumn("group1_name"),a.toggleColumn("group2_name"),a.toggleColumn("group3_name")}),$(document).delegate("#rest_range","input",function(){var e=$(this).val();F.render_rest_btn(e),$("#rest_value").text(e+"分")}),$(document).delegate(".r_btn","click",function(){var e=$(this).attr("data-time");F.render_rest_btn(e),$("#rest_range").val(e),$("#rest_value").text(e+"分"),$("#time_edit_submit").removeClass("disable")}),$(document).delegate(".time-val","input change",function(){$("#time_edit_submit").removeClass("disable")}),$(document).delegate(".shift-btn","click",function(){F.render_shift_btn($(this).text()),$("#time_edit_submit").removeClass("disable")}),$(document).delegate("#time_edit_submit","click",function(){$("#time_edit_submit").addClass("disable"),0===h&&D().done(function(e){"ok"===e.message?($("#modal2").iziModal("close"),F.show_toast(e.today+" 修正登録 "+$("#user_name").text()+" "+e.user_id),F.renderUsersTableData(),0===shift_view_flag&&F.renderShiftTableData(),1===shift_view_flag&&F.render_cal_data()):F.show_err_toast("通信エラー")}).fail(function(){F.show_err_toast("通信エラー")}),1!==h||0===n&&""===$("#select-in_hour").val()&&""===$("#select-out_hour").val()||x().done(function(e){"ok"===e?($("#modal2").iziModal("close"),F.show_toast("申請シフト反映"),F.renderUsersTableData(),0===shift_view_flag&&F.renderShiftTableData(),1===shift_view_flag&&(F.render_cal_data(),F.rendar_cal_holiday())):F.show_err_toast("通信エラー")}).fail(function(){F.show_err_toast("通信エラー")})}),$(document).delegate("#shift_view_change","click",function(){0===shift_view_flag?($("#register_submit_btn").show(),$("#shift_table").html(""),$("#shift_table").removeClass("tabulator"),$("#shift_view_title").html('<i class="far fa-calendar"></i> カレンダー'),F.render_calendar(),shift_view_flag=1):1===shift_view_flag&&($("#register_submit_btn").hide(),$("#shift_table").html(""),$("#shift_table").removeClass("fc fc-ltr fc-unthemed"),C(),F.renderShiftTableColumns(),$("#shift_view_title").html('<i class="fas fa-list"></i> リスト'),shift_view_flag=0)}),$(document).delegate("#register_submit_btn","click",function(){$(this).addClass("disabled"),k().done(function(e){$.each(e,function(e,t){"ok"==t.message?F.show_toast("申請シフト反映 "+t.dk_date):F.show_err_toast("反映エラー"+t.dk_date)}),F.renderUsersTableData(),F.render_cal_data(),F.rendar_cal_holiday()}).fail(function(){F.show_err_toast("通信エラー")})}),$(document).delegate("#select_group_1","change",function(){a.removeFilter("group1_name","=",_),"ALL"!==(_=$(this).val())&&a.addFilter("group1_name","=",_)}),$(document).delegate("#select_group_2","change",function(){a.removeFilter("group2_name","=",u),"ALL"!==(u=$(this).val())&&a.addFilter("group2_name","=",u)}),$(document).delegate("#select_group_3","change",function(){a.removeFilter("group3_name","=",c),"ALL"!==(c=$(this).val())&&a.addFilter("group3_name","=",c)}),$(document).delegate("#shift_status","change",function(){a.removeFilter("shift","=",0),a.removeFilter("shift",">",0),a.removeFilter("shift","=",s),a.removeFilter("shift","!=",s);var e=$(this).val();0==e&&a.addFilter("shift","=",0),1==e&&(a.addFilter("shift",">",0),a.addFilter("shift","!=",s)),2==e&&a.addFilter("shift","=",s)}),$(document).delegate("#user_select_disable","click",function(){F.render_del_select()})})}();