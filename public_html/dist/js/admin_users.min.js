!function(){var n,a,l,r=function(){return $.ajax({url:"../data/columns/users",dataType:"json",type:"POST"})},o=function(e){var t=e.length,n=e.filter(function(e){return 1==e.state}),e=e.filter(function(e){return 2==e.state}),t={all_count:t,all_state_count:n.length,all_resign_count:e.length};s.renderTotal(t)},i=function(e){var t=e.filter(function(e){return"男"==e.sex}),n=e.filter(function(e){return"女"==e.sex}),a=e.filter(function(e){return""==e.sex}),e={count_all:e.length,sex_man:t.length,sex_woman:n.length,sex_no:a.length};s.renderFilterTotal(e)},e=function(e){var e="../../data/admin_download/"+e,t=document.createElement("form"),e=(t.setAttribute("action",e),t.setAttribute("method","post"),t.style.display="none",document.body.appendChild(t),document.createElement("input")),e=(e.setAttribute("type","hidden"),e.setAttribute("name","column"),e.setAttribute("value",JSON.stringify(a)),t.appendChild(e),document.createElement("input")),e=(e.setAttribute("type","hidden"),e.setAttribute("name","dl_data"),e.setAttribute("value",JSON.stringify(l)),t.appendChild(e),document.createElement("input")),e=(e.setAttribute("type","hidden"),e.setAttribute("name","type"),e.setAttribute("value","users"),t.appendChild(e),document.createElement("input"));e.setAttribute("type","hidden"),e.setAttribute("name","data_date"),e.setAttribute("value",""),t.appendChild(e),t.submit()},u=function(e){return $.ajax({type:"POST",url:"../../data/admin_users/save_data",data:{user_id:e.user_id,field:e.field,value:e.value}})},s={renderTableColumns:new Promise(function(t,e){r().done(function(e){a=e.filter(function(e){return e.output}),(n=new Tabulator("#data_table",{height:"calc(100vh - 280px)",columns:e,dataLoaded:function(e){o(e)},dataFiltered:function(e,t){var n=[];if(0<t.length){for(var a=0;a<t.length;a++)n.push(t[a]._row.data);i(n),l=n}},dataSorted:function(e,t){var n=[];if(0<t.length){for(var a=0;a<t.length;a++)n.push(t[a]._row.data);l=n}},cellEdited:function(e){var t=[];t.field=e.getField(),t.value=e.getValue(),t.user_id=e.getData().user_id,u(t).done(function(e){console.log("ok"),console.log(e)}).fail(function(e){console.log(e)})},cellClick:function(e,t){t.getData().user_id&&2!==authority&&5!==authority&&"area_id"!==t.getField()&&"mypage_self"!==t.getField()&&(Cookies.set("userDetailUserId",parseInt(t.getData().user_id)),window.location.href="admin_user_detail")},invalidOptionWarnings:!1,rowFormatter:function(e){"管理のみ"==e.getData().management_flag&&(e.getElement().style.backgroundColor="rgba(204, 204, 204, 0.5)")}})).hideColumn("resign_date"),t(),n.hideColumn("management_flag")})}),renderTableData:function(){n.replaceData("../data/admin_users/table_data",{},"POST")},renderFilter:function(e){"0"===e&&(n.showColumn("resign_date"),n.clearFilter()),"1"===e&&(n.hideColumn("resign_date"),n.setFilter("state","=",e)),"2"===e&&(n.showColumn("resign_date"),n.setFilter("state","=",e))},renderTotal:function(e){$("#user_all_num").text(e.all_count),$("#user_state_num").text(e.all_state_count),$("#user_resign_num").text(e.all_resign_count),0<e.all_state_count&&0<e.all_count&&$("#user_state_rate").text((e.all_state_count/e.all_count*100).toFixed(1)),0<e.all_resign_count&&0<e.all_count&&$("#user_resign_rate").text((e.all_resign_count/e.all_count*100).toFixed(1))},renderFilterTotal:function(e){$("#sex_man").text(e.sex_man),$("#sex_woman").text(e.sex_woman),$("#sex_no").text(e.sex_no),0<e.sex_man&&0<e.count_all?$("#sex_man_rate").text((e.sex_man/e.count_all*100).toFixed(1)):$("#sex_no_rate").text("-"),0<e.sex_woman&&0<e.count_all?$("#sex_woman_rate").text((e.sex_woman/e.count_all*100).toFixed(1)):$("#sex_no_rate").text("-"),0<e.sex_no&&0<e.count_all?$("#sex_no_rate").text((e.sex_no/e.count_all*100).toFixed(1)):$("#sex_no_rate").text("-")}};$(function(){Promise.all([s.renderTableColumns]).then(function(){s.renderTableData(),n.setFilter("state","=",1)}),$('select[name="user_state_filter"]').on("change",function(){var e=$('select[name="user_state_filter"] option:selected').val();s.renderFilter(e)}),2!==authority&&5!==authority||$("#create_user").addClass("disabled"),$(document).delegate("#create_user","click",function(){Cookies.set("userDetailUserId","new"),window.location.href="admin_user_detail"}),$(document).delegate("#download_btn_excel","click",function(){e("xlsx")}),$(document).delegate("#download_btn_pdf","click",function(){e("pdf")})})}();