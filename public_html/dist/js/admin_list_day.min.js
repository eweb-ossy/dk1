!function(){var a,r,i,o,l,d,m,c,f,h,n={},b={},p="",u="none";function _(e,t){if((t=(t=(t=(t=(t=(t=t.replace(/YYYY/g,e.getFullYear())).replace(/MM/g,("0"+(e.getMonth()+1)).slice(-2))).replace(/DD/g,("0"+e.getDate()).slice(-2))).replace(/hh/g,("0"+e.getHours()).slice(-2))).replace(/mm/g,("0"+e.getMinutes()).slice(-2))).replace(/ss/g,("0"+e.getSeconds()).slice(-2))).match(/S/g)){var a=("00"+e.getMilliseconds()).slice(-3),r=t.match(/S/g).length;for(let e=0;e<r;e++)t=t.replace(/S/,a.substring(e,e+1))}return t}function s(e){return Math.floor(e/60)+":"+("0"+e%60).slice(-2)}const g={getTableColumns:function(){return $.ajax({url:"../data/columns/list_day",dataType:"json"})},save_data:function(){return $.ajax({type:"POST",dataType:"json",url:"../../data/admin_list_day/save",data:{today:_(new Date(i),"YYYY-MM-DD"),user_id:b.user_id,in_time:$("#picker_in_time").val(),out_time:$("#picker_out_time").val(),rest:$("#rest_range").val(),memo:$("#memo").val(),area_id:$('select[name="place"] option:selected').attr("data-area-id"),shift_in_time:$("#picker_shift_in_time").val(),shift_out_time:$("#picker_shift_out_time").val(),shift_rest:$("#shift_rest_range").val(),shift_status:u,shift_hour:h}})},downloadData:function(e){var e="../../data/admin_download/"+e,t=document.createElement("form"),e=(t.setAttribute("action",e),t.setAttribute("method","post"),t.style.display="none",document.body.appendChild(t),document.createElement("input")),e=(e.setAttribute("type","hidden"),e.setAttribute("name","column"),e.setAttribute("value",JSON.stringify(o)),t.appendChild(e),document.createElement("input")),e=(e.setAttribute("type","hidden"),e.setAttribute("name","dl_data"),e.setAttribute("value",JSON.stringify(l)),t.appendChild(e),document.createElement("input")),e=(e.setAttribute("type","hidden"),e.setAttribute("name","type"),e.setAttribute("value","day"),t.appendChild(e),document.createElement("input")),e=(e.setAttribute("type","hidden"),e.setAttribute("name","data_date"),e.setAttribute("value",$("#datepicker").val()),t.appendChild(e),document.createElement("input"));e.setAttribute("type","hidden"),e.setAttribute("name","all_data"),e.setAttribute("value",JSON.stringify(n)),t.appendChild(e),t.submit()},listData:function(e){var t=e.filter(e=>0<e.work_hour2),t=(n.work_minute=t.reduce((e,t)=>e+Number(t.work_hour2),0),n.work_hour=0<n.work_minute?s(n.work_minute):"",e.filter(e=>0<e.normal_hour2)),t=(n.normal_minute=t.reduce((e,t)=>e+Number(t.normal_hour2),0),n.normal_hour=0<n.normal_minute?s(n.normal_minute):"",e.filter(e=>0<e.shift_hour2)),t=(n.shift_hour2=t.reduce((e,t)=>e+Number(t.shift_hour2),0),n.shift_hour=0<n.shift_hour2?s(n.shift_hour2):"",e.filter(e=>0<e.rest_hour2)),t=(n.rest_minute=t.reduce((e,t)=>e+Number(t.rest_hour2),0),n.rest_hour=0<n.rest_minute?s(n.rest_minute):"",e.filter(e=>0<e.over_hour2)),t=(n.over_minute=t.reduce((e,t)=>e+Number(t.over_hour2),0),n.over_hour=0<n.over_minute?s(n.over_minute):"",e.filter(e=>0<e.night_hour2)),t=(n.night_minute=t.reduce((e,t)=>e+Number(t.night_hour2),0),n.night_hour=0<n.night_minute?s(n.night_minute):"",e.filter(e=>0<e.late_hour2)),t=(n.late_minute=t.reduce((e,t)=>e+Number(t.late_hour2),0),n.late_hour=0<n.late_minute?s(n.late_minute):"",e.filter(e=>0<e.left_hour2));n.left_minute=t.reduce((e,t)=>e+Number(t.left_hour2),0),n.left_hour=0<n.left_minute?s(n.left_minute):""}};function v(e){var t=[];if(0<e.length){for(var a=0;a<e.length;a++)t.push(e[a]._row.data);g.listData(t),l=t}}const k={renderTableColumns:new Promise(function(t,e){g.getTableColumns().done(e=>{(o=e.filter(e=>e.output)).forEach((e,t)=>{let a=0===t?"合計":"";e.field?n[e.field]=a:e.columns.forEach(e=>{n[e.field]=a})}),a=new Tabulator("#data_table",{height:"calc(100vh - 262px)",layout:"fitDataStretch",columns:e,tooltips:function(e){var t=e.getColumn(),t=("in_work_time"!=t._column.field&&"out_work_time"!=t._column.field&&"work_hour"!=t._column.field&&"work_minute"!=t._column.field&&"rest_hour"!=t._column.field&&"rest_minute"!=t._column.field&&"status"!=t._column.field||(e.getElement().style.color="#1591a2"),"over_hour"!=t._column.field&&"over_minute"!=t._column.field&&"night_hour"!=t._column.field&&"night_minute"!=t._column.field&&"late_hour"!=t._column.field&&"late_minute"!=t._column.field&&"left_hour"!=t._column.field&&"left_minute"!=t._column.field||(e.getElement().style.color="#ff4560"),"normal_hour"!=t._column.field&&"normal_minute"!=t._column.field||(e.getElement().style.color="#673AB7"),"shift_in_time"!=t._column.field&&"shift_out_time"!=t._column.field&&"shift_hour"!=t._column.field||(e.getElement().style.color="#9abcea"),e.getValue());"片打刻"==t&&(e.getElement().style.color="#ff4560"),"未出勤"==t&&(e.getElement().style.color="#673ab7"),"出勤"==t&&(e.getElement().style.color="#9abcea"),"公休"==t&&(e.getElement().style.color="#F44336"),"有給"!=t&&"有給取得"!=t||(e.getElement().style.color="#fff",e.getElement().style.background="#40a598"),"欠勤"==t&&(e.getElement().style.color="#fff",e.getElement().style.background="#fd6b80")},dataFiltered:function(e,t){v(t)},dataSorted:function(e,t){v(t)},rowClick:function(e,t){2!==authority&&5!==authority&&(b=t.getData()).user_id&&k.render_modal(b)},invalidOptionWarnings:!1}),t(),a.hideColumn("work_hour2"),a.hideColumn("rest_hour2"),a.hideColumn("over_hour2"),a.hideColumn("night_hour2"),a.hideColumn("group1_order"),a.hideColumn("group2_order"),a.hideColumn("group3_order"),a.hideColumn("in_latitude"),a.hideColumn("in_longitude"),a.hideColumn("out_latitude"),a.hideColumn("out_longitude"),a.hideColumn("area_id"),a.hideColumn("normal_hour2"),a.hideColumn("shift_hour2"),a.hideColumn("shift_rest"),a.hideColumn("group1_name"),a.hideColumn("group2_name"),a.hideColumn("group3_name")})}),renderDate:new Promise(function(e,t){r=flatpickr("#datepicker",{dateFormat:"Y年m月d日(D)",defaultDate:"today",locale:{firstDayOfWeek:0},onChange:function(){i=r.selectedDates[0],k.renderTableData()}}),e()}),renderTableData:function(){r.setDate(i);var e=_(new Date(i),"YYYY-MM-DD"),t=(e===_(new Date,"YYYY-MM-DD")?($("#date_today").addClass("disable"),$("#today_mark").addClass("today"),$("#today_mark").text("本日")):($("#date_today").removeClass("disable"),$("#today_mark").removeClass("today"),0<(t=Math.ceil((i-new Date)/864e5))?$("#today_mark").text(t+"日後"):$("#today_mark").text(Math.abs(t)+"日前")),new Intl.DateTimeFormat("ja-JP-u-ca-japanese",{era:"long",year:"numeric"}).format(new Date(i)));$("#date-area-wareki").text(t),a.clearData(),a.replaceData("../data/admin_list_day/table_data",{date:e},"POST").then(function(){k.renderListData()})},render_modal:function(e){$("#modal_date").text($("#datepicker").val());var t=e.in_work_time||"",t=(d=flatpickr("#picker_in_time",{enableTime:!0,noCalendar:!0,dateFormat:"H:i",time_24hr:!0,defaultHour:defaultInHour,defaultMinute:defaultInMinute,minuteIncrement:defaultMinuteIncrement,defaultDate:t,onChange:function(){k.render_modal_check()},onClose:function(){k.render_modal_check()}}),m=flatpickr("#picker_out_time",{enableTime:!0,noCalendar:!0,dateFormat:"H:i",time_24hr:!0,defaultHour:defaultOutHour,defaultMinute:defaultOutMinute,minuteIncrement:defaultMinuteIncrement,defaultDate:e.out_work_time,onChange:function(){k.render_modal_check()},onClose:function(){k.render_modal_check()}}),e.shift_in_time||""),t=(c=flatpickr("#picker_shift_in_time",{enableTime:!0,noCalendar:!0,dateFormat:"H:i",time_24hr:!0,defaultHour:defaultInHour,defaultMinute:defaultInMinute,minuteIncrement:defaultMinuteIncrement,defaultDate:t,onChange:function(){k.render_modal_check()},onClose:function(){k.render_modal_check()}}),f=flatpickr("#picker_shift_out_time",{enableTime:!0,noCalendar:!0,dateFormat:"H:i",time_24hr:!0,defaultHour:defaultOutHour,defaultMinute:defaultOutMinute,minuteIncrement:defaultMinuteIncrement,defaultDate:e.shift_out_time,onChange:function(){k.render_modal_check()},onClose:function(){k.render_modal_check()}}),e.in_work_time||"--"),t=($("#in_time").text(t),e.out_work_time||"--"),t=($("#out_time").text(t),e.work_hour2?e.work_hour2+"分":"--"),t=($("#work_value").text(t),e.work_hour||""),t=($("#work_value2").text(t),$("#rest_range").prop("disabled",!1).val(Number(e.rest_hour2)),e.rest_hour2||0),t=(k.render_rest_btn(t),e.rest_hour||"0:00"),a=($("#rest_value2").text(t),(e.area?$('[name="place"] > option[value="'+e.area+'"]'):$('[name="place"] > option[value=""]')).prop("selected",!0),$("#memo").val(e.memo),$(".iziModal-header-title").text(e.user_name),$('[tabulator-field="group1_name"] > .tabulator-col-content > .tabulator-col-title').text()),r=$('[tabulator-field="group2_name"] > .tabulator-col-content > .tabulator-col-title').text(),i=$('[tabulator-field="group3_name"] > .tabulator-col-content > .tabulator-col-title').text(),a=($(".iziModal-header-subtitle").text("ID："+e.user_id+"　"+a+"："+e.group1_name+"　"+r+"："+e.group2_name+"　"+i+"："+e.group3_name),e.in_latitude&&e.in_longitude?$("#map_in").html('<iframe src="https://maps.google.co.jp/maps?output=embed&t=m&hl=ja&z=15&ll='+e.in_latitude+","+e.in_longitude+"&q="+e.in_latitude+","+e.in_longitude+'" frameborder="0" scrolling="no" width="323px" height="78px"></iframe>'):$("#map_in").html(""),e.out_latitude&&e.out_longitude?$("#map_out").html('<iframe src="https://maps.google.co.jp/maps?output=embed&t=m&hl=ja&z=15&ll='+e.out_latitude+","+e.out_longitude+"&q="+e.out_latitude+","+e.out_longitude+'" frameborder="0" scrolling="no" width="323px" height="78px"></iframe>'):$("#map_out").html(""),e.shift_in_time||"--"),r=($("#shift_in_time").text(a),e.shift_out_time||"--"),i=($("#shift_out_time").text(r),e.shift_hour2?e.shift_hour2+"分":"--"),a=($("#shift_value").text(i),e.shift_hour||""),r=($("#shift_value2").text(a),p=e.shift_status,k.render_shift_btn(p),$("#shift_rest_range").prop("disabled",!1).val(Number(e.shift_rest)),e.shift_rest||0),t=(k.render_shift_rest_btn(r),e.rest_hour||"0:00");$("#rest_value2").text(t),$("#time_edit_submit").attr("data-user-id",e.user_id),$("#time_edit_submit").addClass("disable"),$("#modal2").iziModal("open")},render_rest_btn:function(e){$(".r_btn").removeClass("active"),$("#rest_"+e).addClass("active"),$("#memori_"+e).addClass("active"),$("#rest_value").text(e+"分");var t=e/60,a=Math.floor(t),t=Math.round(60*(t-a));$("#rest_value2").text(a+":"+("0"+t).slice(-2)),$("#rest_range").val(e),k.render_modal_check()},render_shift_rest_btn:function(e){$(".rs_btn").removeClass("active-s"),$("#shift_rest_"+e).addClass("active-s"),$("#shift_memori_"+e).addClass("active-s"),$("#shift_rest_value").text(e+"分");var t=e/60,a=Math.floor(t),t=Math.round(60*(t-a));$("#shift_rest_value2").text(a+":"+("0"+t).slice(-2)),$("#shift_rest_range").val(e),k.render_modal_check()},render_shift_btn:function(e){var t;$(".shift-btn").removeClass("disabled"),$("#shift_time_edit_area").hide(),u="none","未登録"!==e&&""!==e||($("#state_none").addClass("disabled"),p="",t="#ccc",u="del"),"出勤"===e&&($("#state_work").addClass("disabled"),p="出勤",t="#3788d8",u=0,$("#shift_time_edit_area").show()),"公休"===e&&($("#state_rest").addClass("disabled"),p="公休",u=1,t="#ff7d73"),"有給"===e&&($("#state_raid").addClass("disabled"),p="有給",u=2,t="#40a598"),$("#status_name").text("シフト "+p).css("color",t)},render_modal_check:function(){$("#time_edit_submit").addClass("disable"),$(".time-input, .rest-value, .shift-rest-value").removeClass("error"),$("#work_value, #shift_value").text("--"),$("#work_value2, #shift_value2").text("");var e=d.selectedDates,o=m.selectedDates,l=new Date(e).getHours();let t=60*l+new Date(e).getMinutes();e=new Date(o).getHours();let n=60*e+new Date(o).getMinutes(),u=$("#picker_in_time").val(),_=$("#picker_out_time").val();0<over_day&&(l<=over_day&&(t+=1440,o=u.substr(0,2),l=u.substr(-2),o=Number(o)+24,u=o+":"+l),e<=over_day&&(n+=1440,o=_.substr(0,2),l=_.substr(-2),o=Number(o)+24,_=o+":"+l));e=$("#rest_range").val();if(!t&&!n&&0<e)$(".rest-value").addClass("error");else if(t&&!n&&0<e)$(".rest-value").addClass("error");else if(!t&&n)$("#picker_in_time").addClass("error"),0<e&&$(".rest-value").addClass("error");else{if(t&&n){o=n-t;if(o-e<=0)return void $("#picker_out_time").addClass("error");if(o<=e)return void $(".rest-value").addClass("error");o-=e,$("#work_value").text(o+"分");l=o/60,o=Math.floor(l),l=Math.round(60*(l-o));$("#work_value2").text(o+":"+("0"+l).slice(-2))}let a,r,i;if("出勤"===p){o=new Date(c.selectedDates).getHours();let e=60*o+new Date(c.selectedDates).getMinutes();l=new Date(f.selectedDates).getHours();let t=60*l+new Date(f.selectedDates).getMinutes();if(a=$("#picker_shift_in_time").val(),r=$("#picker_shift_out_time").val(),0<over_day&&(o<=over_day&&(e+=1440,o=a.substr(0,2),s=a.substr(-2),o=Number(o)+24,a=o+":"+s),l<=over_day&&(t+=1440,o=r.substr(0,2),s=r.substr(-2),o=Number(o)+24,r=o+":"+s)),!e)return void $("#picker_shift_in_time").addClass("error");if(!t)return void $("#picker_shift_out_time").addClass("error");if(e&&t){if(i=$("#shift_rest_range").val(),(h=t-e)-i<=0)return void $("#picker_shift_out_time").addClass("error");if(h<=i)return void $(".shift-rest-value").addClass("error");h-=i,$("#shift_value").text(h+"分");var l=h/60,o=Math.floor(l),s=Math.round(60*(l-o));$("#shift_value2").text(o+":"+("0"+s).slice(-2))}}b.in_work_time!=u&&$("#time_edit_submit").removeClass("disable"),b.out_work_time!=_&&$("#time_edit_submit").removeClass("disable");(b.rest_hour2||0)!=e&&$("#time_edit_submit").removeClass("disable");l=$('select[name="place"] option:selected').attr("data-area-id"),o=(b.area_id!=l&&$("#time_edit_submit").removeClass("disable"),$("#memo").val());b.memo!=o&&$("#time_edit_submit").removeClass("disable"),b.shift_status!=p&&$("#time_edit_submit").removeClass("disable"),"出勤"===p&&(b.shift_in_time!=a&&$("#time_edit_submit").removeClass("disable"),b.shift_out_time!=r&&$("#time_edit_submit").removeClass("disable"),(b.shift_rest||0)!=i&&$("#time_edit_submit").removeClass("disable"))}},show_toast:function(e){siiimpleToast.message(e,{position:"top|right"})},show_err_toast:function(e){siiimpleToast.alert(e,{position:"top|right"})},renderListData:function(){$('.tabulator-calcs-top > [tabulator-field="user_id"]').text("合計"),$('.tabulator-calcs-top > [tabulator-field="work_hour"]').text(n.work_hour),$('.tabulator-calcs-top > [tabulator-field="work_minute"]').text(n.work_minute),$('.tabulator-calcs-top > [tabulator-field="rest_hour"]').text(n.rest_hour),$('.tabulator-calcs-top > [tabulator-field="rest_minute"]').text(n.rest_minute),$('.tabulator-calcs-top > [tabulator-field="late_hour"]').text(n.late_hour),$('.tabulator-calcs-top > [tabulator-field="late_minute"]').text(n.late_minute),$('.tabulator-calcs-top > [tabulator-field="left_hour"]').text(n.left_hour),$('.tabulator-calcs-top > [tabulator-field="left_minute"]').text(n.left_minute),$('.tabulator-calcs-top > [tabulator-field="over_hour"]').text(n.over_hour),$('.tabulator-calcs-top > [tabulator-field="over_minute"]').text(n.over_minute),$('.tabulator-calcs-top > [tabulator-field="night_hour"]').text(n.night_hour),$('.tabulator-calcs-top > [tabulator-field="night_minute"]').text(n.night_minute),$('.tabulator-calcs-top > [tabulator-field="normal_hour"]').text(n.normal_hour),$('.tabulator-calcs-top > [tabulator-field="normal_minute"]').text(n.normal_minute),$('.tabulator-calcs-top > [tabulator-field="shift_hour"]').text(n.shift_hour)}};$(function(){function e(e){i=e?new Date(i.setDate(i.getDate()+e)):new Date,k.renderTableData()}Promise.all([k.renderTableColumns,k.renderDate]).then(function(){i=r.selectedDates[0],k.renderTableData()}),$("#modal2").iziModal({headerColor:"#1591a2",focusInput:!1,width:700}),$("#less_day").on("click",function(){e(-1)}),$("#add_day").on("click",function(){e(1)}),$("#today_mark, #date_today").on("click",function(){e()}),$("#table_window_btn").on("click",function(){$(this).toggleClass("on"),a.toggleColumn("group1_name"),a.toggleColumn("group2_name"),a.toggleColumn("group3_name")}),$(document).on("input","#rest_range",function(){var e=$(this).val();k.render_rest_btn(e)}),$(document).on("click",".r_btn",function(){var e=$(this).attr("data-time");k.render_rest_btn(e)}),$(document).on("input change",".time-val",function(){k.render_modal_check()}),$(document).on("click","#picker_del_in_time",function(){d.clear(),k.render_modal_check()}),$(document).on("click","#picker_del_out_time",function(){m.clear(),k.render_modal_check()}),$(document).on("click","#shift_view_btn",function(){$(this).toggleClass("active-shift"),$("#shift_btn_area").slideToggle(),k.render_shift_btn(b.shift_status)}),$(document).on("click",".shift-btn",function(){k.render_shift_btn($(this).text()),k.render_modal_check()}),$(document).on("input","#shift_rest_range",function(){var e=$(this).val();k.render_shift_rest_btn(e)}),$(document).on("click",".rs_btn",function(){var e=$(this).attr("data-time");k.render_shift_rest_btn(e)}),$(document).on("click","#picker_shift_del_in_time",function(){c.clear(),k.render_modal_check()}),$(document).on("click","#picker_shift_del_out_time",function(){f.clear(),k.render_modal_check()}),$(document).on("click","#time_edit_submit",function(){g.save_data().done(function(e){"ok"===e.message?($("#modal2").iziModal("close"),k.show_toast(e.today+" 修正登録 "+b.user_name+" "+e.user_id),k.renderTableData()):k.show_err_toast("通信エラー")}).fail(function(){k.show_err_toast("通信エラー")})}),$("#download_btn_excel").on("click",function(){g.downloadData("xlsx")}),$("#download_btn_pdf").on("click",function(){g.downloadData("pdf")})})}();