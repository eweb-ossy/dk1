!function(){function r(e,t){if((t=(t=(t=(t=(t=(t=t.replace(/YYYY/g,e.getFullYear())).replace(/MM/g,("0"+(e.getMonth()+1)).slice(-2))).replace(/DD/g,("0"+e.getDate()).slice(-2))).replace(/hh/g,("0"+e.getHours()).slice(-2))).replace(/mm/g,("0"+e.getMinutes()).slice(-2))).replace(/ss/g,("0"+e.getSeconds()).slice(-2))).match(/S/g))for(var a=("00"+e.getMilliseconds()).slice(-3),n=t.match(/S/g).length,i=0;i<n;i++)t=t.replace(/S/,a.substring(i,i+1));return t}var i,o,d,t,n,s,a=$("#user_id").attr("data-num"),l="",u=Number($("#input_area").attr("data-message")),_=[],c=0,m="",f=1,h="",g="",b="",p="",w={},e=function(){return axios.get("../../data/nowDateTime/")},v=function(e){return navigator.geolocation.getCurrentPosition(function(e){h="取得",g=e.coords.latitude,b=e.coords.longitude},function(e){switch(h="不明エラー",e.code){case 1:h="拒否";break;case 2:h="失敗";break;case 3:h="タイムアウト"}},{enableHighAccuracy:!0}),$.ajax({type:"POST",dataType:"json",url:"../../data/gateway/user",data:{user_id:e}})},y=function(a){var e,t;if(0===j||1===j&&"取得"===h||2===j&&"pc"!==S&&"取得"===h||2===j&&"pc"===S)return e=new $.Deferred,$.ajax({type:"POST",dataType:"json",url:"../../data/gateway/insert",data:{flag:a,user_id:i,user_name:o,area_id:Y,latitude:g,longitude:b,info:h}}).done(function(e){var t;"ng"===e.message?T.show_err_toast("データ登録エラー：出退勤情報を保存できませんでした。もう一度やり直してください。"):("in"===a&&(t="おはようございます",1==message_in_flag&&($("#modal4").iziModal("open"),T.clearTimer(),$("#message_in").trigger("focus"))),"out"===a&&(t="おつかれさまです",1==message_out_flag&&($("#modal5").iziModal("open"),T.clearTimer(),$("#message_out").trigger("focus"))),T.show_toast(t+"<br>"+e.message),T.render_id_clear())}).fail(function(e){T.show_err_toast("通信エラー")}).always(function(){e.resolve()}),e;T.show_err_toast("位置情報取得エラー："+h+"<br><br>"+(t="in"===a?"出勤":"退勤")+"できませんでした。<br><br>もう一度"+t+"をするか、ログアウトしてやり直して下さい。")},k=function(){return $.ajax({type:"POST",dataType:"json",url:"../../data/gateway/status",data:{user_id:i}})},C=function(){return $.ajax({type:"POST",dataType:"json",url:"../../data/gateway/shift",data:{user_id:i}})},F=function(){return $.ajax({type:"POST",dataType:"json",url:"../../data/notice/user_work_status",data:{user_id:i,date:p}})},N=function(){return $.ajax({type:"POST",url:"../../data/notice/new",data:{to_user_id:i,to_date:p,notice_flag:f,notice_in_time:$("#picker_in_time").val(),notice_out_time:$("#picker_out_time").val(),notice_text:$("#memo").val(),user_name:o,end_date:m,noticeHopeData:w}})},x=function(a){var n=new $.Deferred;return $.ajax({type:"POST",dataType:"json",url:"../../data/gateway/insert_rest",data:{flag:a,user_id:i,user_name:o}}).done(function(e){if("err"===e.message)return T.show_err_toast("通信エラー"),n;var t;"in"===a&&(t="休憩を開始します"),T.show_toast((t="out"===a?"休憩を終了します":t)+"<br>"+e.message),T.render_id_clear()}).fail(function(){T.show_err_toast("通信エラー")}).always(function(){n.resolve()}),n},D=function(e,t){$.ajax({type:"POST",dataType:"json",url:"../../data/gateway/insert_message",data:{user_id:i,type:e,message:t}}).done(function(e){"err"===e.message&&T.show_err_toast("通信エラー"),"ok"===e.message&&T.show_toast("メッセージを送信しました")})},T={render_time:function(){function l(){var e=new Date,t=e.getFullYear(),a=e.getMonth()+1,n=e.getDate(),i=["日","月","火","水","木","金","土"][e.getDay()],o=e.getHours(),s=e.getMinutes(),r=e.getSeconds(),d=e.getMilliseconds(),o=("0"+o).slice(-2),s=("0"+s).slice(-2);u.textContent=t+"年"+("0"+a).slice(-2)+"月"+("0"+n).slice(-2)+"日("+i+")",_.textContent=o+(499<d?" ":":")+s,c.textContent=("0"+r).slice(-2),setTimeout(l,500-e.getMilliseconds()%500)}var u=document.getElementById("date_view"),_=document.getElementById("time_view"),c=document.getElementById("second");l()},rendarDateTime:function(){function a(){e().then(function(e){n.textContent=e.data.date_ja+"("+e.data.week+")";var t=e.data.msec<=500?":":" ";i.textContent=e.data.hour_w+t+e.data.minute_w,o.textContent=e.data.second_w,setTimeout(a,500-e.data.second%500)})}var n=document.getElementById("date_view"),i=document.getElementById("time_view"),o=document.getElementById("second");a()},render_id:function(e){l.length<a&&(l+=e),$("#user_id").text(l)},render_id_clear:function(){l="",$("#user_id").text("　"),$(".user_data").text("　"),$(".header-btn").addClass("disable"),$("#input_btn").addClass("disable"),$("#output_btn").addClass("disable"),$(".rest-bloc").addClass("disable"),1===u&&($("#input_area").addClass("display-no"),$("#message_area").removeClass("display-no"))},render_id_del:function(){0<l.length&&(0===(l=l.slice(0,-1)).length?$("#user_id").text("　"):$("#user_id").text(l))},time_user_clear:function(e){e=setTimeout(function(){T.render_id_clear()},e);_.push(e)},render_user:function(e){i=Number(l),l="",$("#user_id").text("　"),T.clearTimer(),0!==Object.keys(e).length&&1!=e.management_flag?(o=e.user_name,$("#user_name").css("color","#357788").text(o),$("#group1").text(e.group1_name),$("#group2").text(e.group2_name),$("#group3").text(e.group3_name),$("#count").text(e.count),$("#time").text(e.time),$(".header-btn").removeClass("disable"),e.in_flag&&0!==e.in_flag||($("#input_btn").removeClass("disable"),$("#output_btn").addClass("disable"),$(".rest-bloc").addClass("disable")),1===e.in_flag&&0===e.out_flag&&($("#input_btn").addClass("disable"),$("#output_btn").removeClass("disable"),3!==e.rest_flag&&($(".rest-bloc").addClass("disable"),e.auto_rest||(1===e.rest_flag&&$("#rest_in_btn").removeClass("disable"),0===e.rest_flag&&($("#rest_out_btn").removeClass("disable"),$("#output_btn").addClass("disable"))))),1==e.in_flag&&1==e.out_flag&&($("#input_btn").addClass("disable"),$("#output_btn").addClass("disable"),$(".rest-bloc").addClass("disable")),1===u&&($("#input_area").removeClass("display-no"),$("#message_area").addClass("display-no")),$(".iziModal-header-title").text(o),T.time_user_clear(1e4)):($(".user_data").text("　"),$("#user_name").css("color","#e65d5d"),$("#user_name").text("未登録"),1===u&&($("#input_area").addClass("display-no"),$("#message_area").removeClass("display-no")),T.time_user_clear(5e3))},reset_tabs:function(e){$(".month_data").html(""),$(e+" .tabs .tab").removeClass("active"),$(e+" .tabs .tab:first").addClass("active"),$(e+" .tab-content").removeClass("show"),$(e+" .tab-content:first").addClass("show")},render_user_status:function(e){T.reset_tabs("#tabs1");for(var t=0;t<3;t++){var s,r=Array();$.each(e[t],function(e,t){var a,n=0==t.w||7==t.w?"red":6==t.w?"blue":"#3e3a39",i=1==t.today_flag?' style="background:rgba(120, 224, 255, .5);"':"",o=a="";0===gateway_status_view_flag&&(t.in_time&&(o=t.in_time),!t.in_time&&t.in_work_time&&(o=t.in_work_time),t.out_time&&(a=t.out_time),!t.out_time&&t.out_work_time&&(a=t.out_work_time),"未退勤"===t.out_time&&t.out_work_time&&(a=t.out_work_time)),1===gateway_status_view_flag&&(o=t.in_work_time,a=t.out_work_time),s=(1===M?r.push("<tr"+i+"><td>"+t.day+'</td><td style="color:'+n+';">'+t.week+"</td><td>"+o+"</td><td>"+a+"</td></td>"+t.memo+'</td><td><td class="mail-sys"><div class="to-mail-btn" data-date="'+t.date+'">作成</div></td></tr>'):r.push("<tr"+i+"><td>"+t.day+'</td><td style="color:'+n+';">'+t.week+"</td><td>"+o+"</td><td>"+a+"</td></td>"+t.memo+"</td><td></tr>")," "+t.year+"年"+t.month+"月")}),$("#month_"+t).text(s),$("#month_data_"+t).append(r.join())}},render_user_shift:function(e){T.reset_tabs("#tabs2");for(var t=0;t<3;t++){var i,o=Array();$.each(e[t],function(e,t){var a=0==t.w||7==t.w?"red":6==t.w?"blue":"#3e3a39",n=1==t.today_flag?' style="background:rgba(120, 224, 255, .5);"':"";o.push("<tr"+n+"><td>"+t.day+'</td><td style="color:'+a+';">'+t.week+"</td><td>"+t.status+"</td><td>"+t.in_time+"</td><td>"+t.out_time+"</td></td></tr>"),i=" "+t.year+"年"+t.month+"月"}),$("#shift_month_"+t).text(i),$("#shift_month_data_"+t).append(o.join())}},show_toast:function(e){alertify.set("notifier","delay",5),alertify.set("notifier","position","top-right"),alertify.notify(e)},show_err_toast:function(e){alertify.set("notifier","delay",10),alertify.set("notifier","position","top-right"),alertify.error(e)},hover_num_key:function(e){var t;t="clear"===e?"#num_clear div":"enter"===e?"#submit_userid div":"#num_"+e,$(t).toggleClass("hovered"),setTimeout(function(){$(t).toggleClass("hovered")},500)},render_modal2:function(){var e;d?(e=new Date,d.setDate(e),p=r(e,"YYYY-MM-DD"),T.rendar_modal2_date()):d=flatpickr("#modal_date",{inline:!0,defaultDate:"today",onReady:function(e,t,a){p=t,T.rendar_modal2_date(),T.rendar_modal2_status()},onChange:function(e,t,a){p=t,T.rendar_modal2_date(),""===m&&T.rendar_modal2_status()}}),n=flatpickr("#picker_in_time",{enableTime:!0,noCalendar:!0,dateFormat:"H:i",time_24hr:!0,defaultHour:z,defaultMinute:O,minuteIncrement:H,onChange:function(){T.render_modal2_check()},onClose:function(){T.render_modal2_check()}}),s=flatpickr("#picker_out_time",{enableTime:!0,noCalendar:!0,dateFormat:"H:i",time_24hr:!0,defaultHour:I,defaultMinute:P,minuteIncrement:H,onChange:function(){T.render_modal2_check()},onClose:function(){T.render_modal2_check()}}),$("#modal2").iziModal("open")},rendar_modal2_date:function(){10<p.length?(m=p.slice(-10),p=p.slice(0,10)):m="";var e,t,a=new Date(p),n=a.getFullYear(),i=a.getMonth()+1,o=a.getDate(),s=a.getDay(),n=n+"年"+i+"月"+o+"日("+["日","月","火","水","木","金","土"][s]+")";$("#calendar_date").css("font-size","25px"),""!==m&&(o=(i=new Date(m)).getFullYear(),t=i.getMonth()+1,e=i.getDate(),i.getDay(),n+="から<br>"+o+"年"+t+"月"+e+"日("+["日","月","火","水","木","金","土"][s]+")",$("#calendar_date").css("font-size","15px")),$("#calendar_date").html(n),""===m&&(f="",$(".select-notice").hide(),$(".time-edit-area").hide(),$(".notice-comment-area").hide(),$("#paid_hour").hide(),$(".notice-btn").removeClass("disabled"),d&&d.set({mode:"single",maxDate:null,minDate:null}),i=r(new Date,"YYYY-MM-DD"),$(".past, future").removeClass("disabled"),p===i?($("#today_mark").addClass("today"),$("#today_mark").text("本日"),$(".past, .future").removeClass("disabled")):($("#today_mark").removeClass("today"),(0<(o=Math.ceil((a-new Date)/864e5))?($("#today_mark").text(o+"日後"),$(".past")):($("#today_mark").text(Math.abs(o)+"日前"),$(".future"))).addClass("disabled")),t=new Intl.DateTimeFormat("ja-JP-u-ca-japanese",{era:"long",year:"numeric"}).format(a),$("#date-area-wareki").text(t))},rendar_modal2_status:function(){F().done(function(e){t=""!==(w=e).shift.status?["出勤","公休","有給"][e.shift.status]:"未定",$("#shiftStatus").text(t),0==e.shift.status&&e.shift.in_time&&e.shift.out_time?($(".shift-time").show(),$("#shift_in_time").text(e.shift.in_time.substr(0,5)),$("#shift_out_time").text(e.shift.out_time.substr(0,5))):$(".shift-time").hide(),$("#timeStatus").text("未出勤"),$("#in_time").text("--"),$("#out_time").text("--"),n.clear(),s.clear();var t="",a="";e.time&&($("#timeStatus").text(e.time.status),e.time.in_time&&(t=e.time.in_time.substr(0,5),$("#in_time").text(t)),e.time.out_time&&(a=e.time.out_time.substr(0,5),$("#out_time").text(a)),n.setDate(t),s.setDate(a)),""===t&&$("button[data-id='2']").addClass("disabled")})},render_modal2_status_change:function(){T.rendar_modal2_status(),d.setDate(p);var e={mode:"single",maxDate:null,minDate:null};1===f&&($("#in_time_input_area").show(),$("#out_time_input_area").show(),$(".time-edit-area").show()),2===f&&($(".notice-comment-area").show(),$("#noticeComment").text("時刻の削除を依頼する")),3===f&&($("#in_time_input_area").show(),$("#out_time_input_area").hide(),$(".time-edit-area").show()),4===f&&($("#in_time_input_area").hide(),$("#out_time_input_area").show(),$(".time-edit-area").show()),5===f&&($("#in_time_input_area").hide(),$("#out_time_input_area").show(),$(".time-edit-area").show()),7===f&&($(".notice-comment-area").show(),$("#noticeComment").text("欠勤を依頼する")),11===f&&($(".notice-comment-area").show(),$("#noticeComment").text("休暇を依頼する")),8===f&&($(".notice-comment-area").show(),$("#noticeComment").text("その他の依頼をする")),6===f&&(9===t&&(e={mode:"range",maxDate:null,minDate:null}),1===t&&(e={mode:"range",maxDate:null,minDate:new Date}),$(".notice-comment-area").show(),$("#paid_hour").show(),$("#noticeComment").text("有給を依頼する")),d.set(e),T.render_modal2_check()},render_modal2_check:function(){if($("#time_edit_submit").addClass("disable"),""!==f&&""!==$("#memo").val()){if(1===f){var e=$("#picker_in_time").val(),t=$("#picker_out_time").val();if(!e&&!t)return}$("#time_edit_submit").removeClass("disable")}},clearTimer:function(){if(0<_.length){for(var e=0;e<_.length;e++)clearTimeout(_[e]);_=[]}}};let M,Y,j,S,z,O,I,P,H;$(function(){$.ajax({dataType:"json",url:"../../data/gateway/init"}).done(function(e){M=Number(e.gateway_mail_flag),Y=e.area_id,j=Number(e.gps_flag),S=e.agent;var t=e.edit_in_time,a=e.edit_out_time;z=t?t.slice(0,2):null,O=t?t.slice(3,2):null,I=a?a.slice(0,2):null,P=a?a.slice(3,2):null,H=e.edit_min||1,T.render_time(),$("#modal1, #modal3").iziModal({headerColor:"#1591a2",focusInput:!1,onOpened:function(){c=1},onClosed:function(){c=0,T.time_user_clear(1e4)}}),$("#modal2").iziModal({headerColor:"#1591a2",focusInput:!1,width:750,onOpened:function(){var e;c=1,p||(e=new Date,d.setDate(e),p=r(e,"YYYY-MM-DD")),T.rendar_modal2_date(),T.render_modal2_status_change(),0<_.length&&T.clearTimer()},onClosed:function(){c=0,T.time_user_clear(1e4),$("#memo").val("")}}),$("#modal4, #modal5").iziModal({headerColor:"#1591a2",focusInput:!1,onOpened:function(){c=1},onClosed:function(){c=0,$("#message_in").val(""),$("#message_out").val(""),T.time_user_clear(1e3)}})}),$(document).on("keypress",function(e){if(1!==c){e.preventDefault();var t=99;switch(e.which){case 49:case 97:t=1;break;case 50:case 98:t=2;break;case 51:case 99:t=3;break;case 52:case 100:t=4;break;case 53:case 101:t=5;break;case 54:case 102:t=6;break;case 55:case 103:t=7;break;case 56:case 104:t=8;break;case 57:case 105:t=9;break;case 48:case 96:t=0}99!==t&&T.render_id(t),T.hover_num_key(t)}}),hotkeys("clear",function(){T.render_id_clear(),T.hover_num_key("clear")}),hotkeys("backspace",function(){T.render_id_del()}),hotkeys("enter",function(){T.hover_num_key("enter"),l&&v(l).done(function(e){T.render_user(e)}).fail(function(e){T.show_err_toast("通信エラー")})}),$(".num-btn").on("click",function(e){e.preventDefault();e=$(this).children("div").text();T.render_id(e)}),$("#num_clear").on("click",function(e){e.preventDefault(),T.render_id_clear()}),$("#submit_userid").on("click",function(e){e.preventDefault(),l&&v(l).done(function(e){T.render_user(e)}).fail(function(){T.show_err_toast("通信エラー")})}),$("#input_btn").on("click",function(e){e.preventDefault(),$(this).addClass("disable"),y("in")}),$("#output_btn").on("click",function(e){e.preventDefault(),$(this).addClass("disable"),y("out")}),$("#rest_in_btn").on("click",function(e){e.preventDefault(),$(this).addClass("disable"),x("in")}),$("#rest_out_btn").on("click",function(e){e.preventDefault(),$(this).addClass("disable"),x("out")}),$("#status_btn").on("click",function(e){e.preventDefault(),k().done(function(e){T.render_user_status(e),$("#modal1").iziModal("open"),T.clearTimer()}).fail(function(e){T.show_err_toast("通信エラー")})}),$(document).on("click","#mail_btn",function(){T.render_modal2(),T.clearTimer()}),$("#shift_btn").on("click",function(e){e.preventDefault(),C().done(function(e){T.render_user_shift(e),$("#modal3").iziModal("open"),T.clearTimer()}).fail(function(e){T.show_err_toast("通信エラー")})}),$(document).on("click",".tabs li",function(){var e=$(this).parent().parent().find(".tabs li").index(this);$(this).siblings().removeClass("active"),$(this).addClass("active"),$(this).parent().parent().find(".tab-content").removeClass("show").eq(e).addClass("show")}),$(document).on("click",".to-mail-btn",function(){T.render_modal2(),p=$(this).attr("data-date"),setTimeout(function(){d.setDate(p),T.rendar_modal2_date(),T.render_modal2_status_change()},50)}),$(document).on("click",".notice-btn",function(){T.rendar_modal2_date(),$(".select-notice").show(),$(this).addClass("disabled");var e=$(this).text();$("#modal2 .iziModal-header-subtitle").text(e),f=Number($(this).attr("data-id")),t=Number($(this).attr("data-term")),$("#selectNotice").text(e),T.render_modal2_status_change()}),$(document).on("click","#today_mark",function(){var e=new Date;d.setDate(e),p=r(e,"YYYY-MM-DD"),T.rendar_modal2_date(),T.render_modal2_status_change()}),$(document).on("click","#picker_del_in_time",function(){n.clear()}),$(document).on("click","#picker_del_out_time",function(){s.clear()}),$(document).on("keyup","#memo",function(){T.render_modal2_check()}),$(document).on("click","#time_edit_submit",function(){$(this).addClass("disable"),N().done(function(e){"ok"==e?$("#modal2").iziModal("close",{transition:"bounceOutUp"}):T.show_mail_error("通信エラー")}).fail(function(e){T.show_mail_error("通信エラー")})}),$(document).on("click","#message_in_submit",function(){var e=$("#message_in").val();e?($("#modal4").iziModal("close",{transition:"bounceOutUp"}),D("in",e),$("#message_in").val("")):$("#modal4").hasClass("wobble")||($("#modal4").addClass("wobble"),setTimeout(function(){$("#modal4").removeClass("wobble"),$("#message_in").trigger("focus")},1500))}),$(document).on("click","#message_out_submit",function(){var e=$("#message_out").val();e?($("#modal5").iziModal("close",{transition:"bounceOutUp"}),D("out",e),$("#message_out").val("")):$("#modal5").hasClass("wobble")||($("#modal5").addClass("wobble"),setTimeout(function(){$("#modal5").removeClass("wobble"),$("#message_out").trigger("focus")},1500))})})}();